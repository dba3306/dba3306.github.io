<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.7.4">Jekyll</generator><link href="http://localhost:4000/atom.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2020-04-28T22:59:42+08:00</updated><id>http://localhost:4000/atom.xml</id><title type="html">Focus On DB</title><subtitle>一个DBA的自我修养</subtitle><author><name>Nick</name></author><entry><title type="html">快速搭建innodb cluster 集群</title><link href="http://localhost:4000/%E8%BF%90%E7%BB%B4/mysql/2020/04/22/mac%E4%B8%8A%E7%94%A8dbdeploy%E9%83%A8%E7%BD%B2MiC%E9%9B%86%E7%BE%A4/" rel="alternate" type="text/html" title="快速搭建innodb cluster 集群" /><published>2020-04-22T00:00:00+08:00</published><updated>2020-04-22T00:00:00+08:00</updated><id>http://localhost:4000/%E8%BF%90%E7%BB%B4/mysql/2020/04/22/mac%E4%B8%8A%E7%94%A8dbdeploy%E9%83%A8%E7%BD%B2MiC%E9%9B%86%E7%BE%A4</id><content type="html" xml:base="http://localhost:4000/%E8%BF%90%E7%BB%B4/mysql/2020/04/22/mac%E4%B8%8A%E7%94%A8dbdeploy%E9%83%A8%E7%BD%B2MiC%E9%9B%86%E7%BE%A4/">&lt;h3 id=&quot;用dbdeployer-部署3个单节点&quot;&gt;用dbdeployer 部署3个单节点&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;dbdeployer deploy multiple 5.7 -n 3&lt;/code&gt;&lt;/p&gt;

&lt;h3 id=&quot;查看节点状态&quot;&gt;查看节点状态&lt;/h3&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;dbdeployer sandboxes --full-info
.------------------.----------.---------.-----------.----------------------.--------.-------.--------.
|       name       |   type   | version |   host    |         port         | flavor | nodes | locked |
+------------------+----------+---------+-----------+----------------------+--------+-------+--------+
| multi_msb_5_7_29 | multiple | 5.7.29  | 127.0.0.1 | [24630 24631 24632 ] | mysql  |     3 |        |
'------------------'----------'---------'-----------'----------------------'--------'-------'--------'
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;dbdeployer global status
&lt;span class=&quot;c&quot;&gt;# Running &quot;status_all&quot; on multi_msb_5_7_29&lt;/span&gt;
MULTIPLE  /Users/qianyin/sandboxes/multi_msb_5_7_29
node1 : node1 on  -  port       24630 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;24630&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
node2 : node2 on  -  port       24631 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;24631&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
node3 : node3 on  -  port       24632 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;24632&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;下载mysql-shell&quot;&gt;下载MySQL-Shell&lt;/h3&gt;

&lt;p&gt;wget https://dev.mysql.com/get/Downloads/MySQL-Shell/mysql-shell-8.0.19-macos10.15-x86-64bit.tar.gz&lt;/p&gt;

&lt;p&gt;解压后进入mysql shell 目录
bin目录下就3个文件&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nt&quot;&gt;-rwxr-xr-x&lt;/span&gt;@ 1 qianyin  staff    633256 12 17 09:42 mysql-secret-store-keychain&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;-rwxr-xr-x&lt;/span&gt;@ 1 qianyin  staff   7957420 12 17 09:42 mysql-secret-store-login-path&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;-rwxr-xr-x&lt;/span&gt;@ 1 qianyin  staff  31067132 12 17 09:42 mysqlsh&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;我们运行mysqlsh
可以先打\help 看下帮助提示
可以看到支持的模块如下：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; - dba    Used &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;InnoDB cluster administration.
 - mysql  Support &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;connecting to MySQL servers using the classic MySQL
          protocol.
 - mysqlx Used to work with X Protocol sessions using the MySQL X DevAPI.
 - os     Gives access to functions which allow to interact with the operating
          system.
 - shell  Gives access to general purpose functions and properties.
 - sys    Gives access to system specific parameters.
 - util   Global object that groups miscellaneous tools like upgrade checker
          and JSON import.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;部署集群我们需要用到dba功能，再查看dba的帮助信息&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;\? dba&lt;/code&gt;&lt;/p&gt;

&lt;h3 id=&quot;正式配置集群&quot;&gt;正式配置集群&lt;/h3&gt;

&lt;h4 id=&quot;检查并配置3个数据库实例&quot;&gt;检查并配置3个数据库实例&lt;/h4&gt;

&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql-js&amp;gt; &lt;span class=&quot;se&quot;&gt;\c&lt;/span&gt;onnect root@localhost:24630
 MySQL  localhost:24630 ssl  JS &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; dba.configureLocalInstance&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;
Configuring &lt;span class=&quot;nb&quot;&gt;local &lt;/span&gt;MySQL instance listening at port 24630 &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;use &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;an InnoDB cluster...

This instance reports its own address as node-1:24630

ERROR: User &lt;span class=&quot;s1&quot;&gt;'root'&lt;/span&gt; can only connect from &lt;span class=&quot;s1&quot;&gt;'localhost'&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; New account&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; with proper &lt;span class=&quot;nb&quot;&gt;source &lt;/span&gt;address specification to allow remote connection from all instances must be created to manage the cluster.

1&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; Create remotely usable account &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'root'&lt;/span&gt; with same grants and password
2&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; Create a new admin account &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;InnoDB cluster with minimal required grants
3&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; Ignore and &lt;span class=&quot;k&quot;&gt;continue
&lt;/span&gt;4&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; Cancel

Please &lt;span class=&quot;k&quot;&gt;select &lt;/span&gt;an option &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;1]: 
Please provide a &lt;span class=&quot;nb&quot;&gt;source &lt;/span&gt;address filter &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;the account &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;e.g: 192.168.% or % etc&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; or leave empty and press Enter to cancel.
Account Host: %

NOTE: Some configuration options need to be fixed:
+----------------------------------+---------------+----------------+------------------------------------------------+
| Variable                         | Current Value | Required Value | Note                                           |
+----------------------------------+---------------+----------------+------------------------------------------------+
| binlog_checksum                  | CRC32         | NONE           | Update the server variable and the config file |
| enforce_gtid_consistency         | OFF           | ON             | Update the config file and restart the server  |
| gtid_mode                        | OFF           | ON             | Update the config file and restart the server  |
| log_slave_updates                | OFF           | ON             | Update the config file and restart the server  |
| master_info_repository           | FILE          | TABLE          | Update the config file and restart the server  |
| relay_log_info_repository        | FILE          | TABLE          | Update the config file and restart the server  |
| transaction_write_set_extraction | OFF           | XXHASH64       | Update the config file and restart the server  |
+----------------------------------+---------------+----------------+------------------------------------------------+

Some variables need to be changed, but cannot be &lt;span class=&quot;k&quot;&gt;done &lt;/span&gt;dynamically on the server: an option file is required.

Detecting the configuration file...
Default file not found at the standard locations.
Please specify the path to the MySQL configuration file: /Users/qianyin/sandboxes/multi_msb_5_7_29/node1/my.sandbox.cnf
Do you want to perform the required configuration changes? &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;y/n]: y

Cluster admin user &lt;span class=&quot;s1&quot;&gt;'root'&lt;/span&gt;@&lt;span class=&quot;s1&quot;&gt;'%'&lt;/span&gt; created.
Configuring instance...
The instance &lt;span class=&quot;s1&quot;&gt;'node-1:24630'&lt;/span&gt; was configured to be used &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;an InnoDB cluster.
NOTE: MySQL server needs to be restarted &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;configuration changes to take effect.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;依次修改另外2个节点&lt;/p&gt;

&lt;p&gt;查看my.cnf 会发现在文件末尾添加了如下配置：&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;binlog_checksum = NONE
enforce_gtid_consistency = ON
gtid_mode = ON
log_slave_updates = ON
master_info_repository = TABLE
relay_log_info_repository = TABLE
transaction_write_set_extraction = XXHASH64
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;配置完后，检查下&lt;/p&gt;

&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MySQL  localhost:24630 ssl  JS &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; dba.checkInstanceConfiguration&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'root@localhost:24631'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Validating &lt;span class=&quot;nb&quot;&gt;local &lt;/span&gt;MySQL instance listening at port 24631 &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;use &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;an InnoDB cluster...

This instance reports its own address as node-2:24631

Checking whether existing tables comply with Group Replication requirements...
No incompatible tables detected

Checking instance configuration...
Instance configuration is compatible with InnoDB cluster

The instance &lt;span class=&quot;s1&quot;&gt;'node-2:24631'&lt;/span&gt; is valid to be used &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;an InnoDB cluster.

&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;status&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;ok&quot;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3个节点都显示”status”: “ok” 即可。&lt;/p&gt;

&lt;h4 id=&quot;创建集群&quot;&gt;创建集群&lt;/h4&gt;

&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; MySQL  localhost:24630 ssl  JS &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; var cluster &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; dba.createCluster&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'testCluster'&lt;/span&gt;,&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'localAddress'&lt;/span&gt;:&lt;span class=&quot;s1&quot;&gt;'localhost:25630'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;})&lt;/span&gt;
A new InnoDB cluster will be created on instance &lt;span class=&quot;s1&quot;&gt;'localhost:24630'&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;

Disabling super_read_only mode on instance &lt;span class=&quot;s1&quot;&gt;'node-1:24630'&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Validating instance configuration at localhost:24630...

This instance reports its own address as node-1:24630

Instance configuration is suitable.
WARNING: Instance &lt;span class=&quot;s1&quot;&gt;'node-1:24630'&lt;/span&gt; cannot persist Group Replication configuration since MySQL version 5.7.29 does not support the SET PERSIST &lt;span class=&quot;nb&quot;&gt;command&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;MySQL version &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; 8.0.11 required&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; Please use the &amp;lt;Dba&amp;gt;.configureLocalInstance&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;command &lt;/span&gt;locally to persist the changes.
Creating InnoDB cluster &lt;span class=&quot;s1&quot;&gt;'testCluster'&lt;/span&gt; on &lt;span class=&quot;s1&quot;&gt;'node-1:24630'&lt;/span&gt;...

Adding Seed Instance...
Cluster successfully created. Use Cluster.addInstance&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; to add MySQL instances.
At least 3 instances are needed &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;the cluster to be able to withstand up to
one server failure.



Adding Instances to an InnoDB Cluster
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;**注意：先配置/etc/hosts **&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;127.0.0.1 node-1
127.0.0.1 node-2
127.0.0.1 node-3
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;否则报错：&lt;/p&gt;

&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; MySQL  127.0.0.1:24630 ssl  JS &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; cluster.addInstance&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'root@localhost:24631'&lt;/span&gt;,&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'localAddress'&lt;/span&gt;:&lt;span class=&quot;s1&quot;&gt;'localhost:25631'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;})&lt;/span&gt;
Cluster.addInstance: Unknown MySQL server host &lt;span class=&quot;s1&quot;&gt;'node-1'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;MySQL Error 2005&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;添加集群节点&quot;&gt;添加集群节点&lt;/h4&gt;

&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; MySQL  localhost:24630 ssl  JS &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; cluster.addInstance&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'root@localhost:24631'&lt;/span&gt;,&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'localAddress'&lt;/span&gt;:&lt;span class=&quot;s1&quot;&gt;'localhost:25631'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;})&lt;/span&gt;

NOTE: The target instance &lt;span class=&quot;s1&quot;&gt;'node-2:24631'&lt;/span&gt; has not been pre-provisioned &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;GTID &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;is empty&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; The Shell is unable to decide whether incremental state recovery can correctly provision it.
The safest and most convenient way to provision a new instance is through automatic clone provisioning, which will completely overwrite the state of &lt;span class=&quot;s1&quot;&gt;'node-2:24631'&lt;/span&gt; with a physical snapshot from an existing cluster member. To use this method by default, &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;the &lt;span class=&quot;s1&quot;&gt;'recoveryMethod'&lt;/span&gt; option to &lt;span class=&quot;s1&quot;&gt;'clone'&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;

The incremental state recovery may be safely used &lt;span class=&quot;k&quot;&gt;if &lt;/span&gt;you are sure all updates ever executed &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;the cluster were &lt;span class=&quot;k&quot;&gt;done &lt;/span&gt;with GTIDs enabled, there are no purged transactions and the new instance contains the same GTID &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;as the cluster or a subset of it. To use this method by default, &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;the &lt;span class=&quot;s1&quot;&gt;'recoveryMethod'&lt;/span&gt; option to &lt;span class=&quot;s1&quot;&gt;'incremental'&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;


Please &lt;span class=&quot;k&quot;&gt;select &lt;/span&gt;a recovery method &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;I]ncremental recovery/[A]bort &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;default Incremental recovery&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;: 
Validating instance configuration at localhost:24631...

This instance reports its own address as node-2:24631

Instance configuration is suitable.
WARNING: Instance &lt;span class=&quot;s1&quot;&gt;'node-2:24631'&lt;/span&gt; cannot persist Group Replication configuration since MySQL version 5.7.29 does not support the SET PERSIST &lt;span class=&quot;nb&quot;&gt;command&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;MySQL version &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; 8.0.11 required&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; Please use the &amp;lt;Dba&amp;gt;.configureLocalInstance&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;command &lt;/span&gt;locally to persist the changes.
A new instance will be added to the InnoDB cluster. Depending on the amount of
data on the cluster this might take from a few seconds to several hours.

Adding instance to the cluster...

Monitoring recovery process of the new cluster member. Press ^C to stop monitoring and &lt;span class=&quot;nb&quot;&gt;let &lt;/span&gt;it &lt;span class=&quot;k&quot;&gt;continue in &lt;/span&gt;background.
State recovery already finished &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'node-2:24631'&lt;/span&gt;

WARNING: Instance &lt;span class=&quot;s1&quot;&gt;'node-1:24630'&lt;/span&gt; cannot persist configuration since MySQL version 5.7.29 does not support the SET PERSIST &lt;span class=&quot;nb&quot;&gt;command&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;MySQL version &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; 8.0.11 required&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; Please use the &amp;lt;Dba&amp;gt;.configureLocalInstance&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;command &lt;/span&gt;locally to persist the changes.
The instance &lt;span class=&quot;s1&quot;&gt;'localhost:24631'&lt;/span&gt; was successfully added to the cluster.


     MySQL  localhost:24630 ssl  JS &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; cluster.addInstance&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'root@localhost:24632'&lt;/span&gt;,&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'localAddress'&lt;/span&gt;:&lt;span class=&quot;s1&quot;&gt;'localhost:25632'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;})&lt;/span&gt;

NOTE: The target instance &lt;span class=&quot;s1&quot;&gt;'node-3:24632'&lt;/span&gt; has not been pre-provisioned &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;GTID &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;is empty&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; The Shell is unable to decide whether incremental state recovery can correctly provision it.
The safest and most convenient way to provision a new instance is through automatic clone provisioning, which will completely overwrite the state of &lt;span class=&quot;s1&quot;&gt;'node-3:24632'&lt;/span&gt; with a physical snapshot from an existing cluster member. To use this method by default, &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;the &lt;span class=&quot;s1&quot;&gt;'recoveryMethod'&lt;/span&gt; option to &lt;span class=&quot;s1&quot;&gt;'clone'&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;

The incremental state recovery may be safely used &lt;span class=&quot;k&quot;&gt;if &lt;/span&gt;you are sure all updates ever executed &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;the cluster were &lt;span class=&quot;k&quot;&gt;done &lt;/span&gt;with GTIDs enabled, there are no purged transactions and the new instance contains the same GTID &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;as the cluster or a subset of it. To use this method by default, &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;the &lt;span class=&quot;s1&quot;&gt;'recoveryMethod'&lt;/span&gt; option to &lt;span class=&quot;s1&quot;&gt;'incremental'&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;


Please &lt;span class=&quot;k&quot;&gt;select &lt;/span&gt;a recovery method &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;I]ncremental recovery/[A]bort &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;default Incremental recovery&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;: 
Validating instance configuration at localhost:24632...

This instance reports its own address as node-3:24632

Instance configuration is suitable.
WARNING: Instance &lt;span class=&quot;s1&quot;&gt;'node-3:24632'&lt;/span&gt; cannot persist Group Replication configuration since MySQL version 5.7.29 does not support the SET PERSIST &lt;span class=&quot;nb&quot;&gt;command&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;MySQL version &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; 8.0.11 required&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; Please use the &amp;lt;Dba&amp;gt;.configureLocalInstance&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;command &lt;/span&gt;locally to persist the changes.
A new instance will be added to the InnoDB cluster. Depending on the amount of
data on the cluster this might take from a few seconds to several hours.

Adding instance to the cluster...

Monitoring recovery process of the new cluster member. Press ^C to stop monitoring and &lt;span class=&quot;nb&quot;&gt;let &lt;/span&gt;it &lt;span class=&quot;k&quot;&gt;continue in &lt;/span&gt;background.
State recovery already finished &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'node-3:24632'&lt;/span&gt;

WARNING: Instance &lt;span class=&quot;s1&quot;&gt;'node-1:24630'&lt;/span&gt; cannot persist configuration since MySQL version 5.7.29 does not support the SET PERSIST &lt;span class=&quot;nb&quot;&gt;command&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;MySQL version &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; 8.0.11 required&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; Please use the &amp;lt;Dba&amp;gt;.configureLocalInstance&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;command &lt;/span&gt;locally to persist the changes.
WARNING: Instance &lt;span class=&quot;s1&quot;&gt;'node-2:24631'&lt;/span&gt; cannot persist configuration since MySQL version 5.7.29 does not support the SET PERSIST &lt;span class=&quot;nb&quot;&gt;command&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;MySQL version &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; 8.0.11 required&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; Please use the &amp;lt;Dba&amp;gt;.configureLocalInstance&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;command &lt;/span&gt;locally to persist the changes.
The instance &lt;span class=&quot;s1&quot;&gt;'localhost:24632'&lt;/span&gt; was successfully added to the cluster.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;查看cluster-状态&quot;&gt;查看cluster 状态&lt;/h4&gt;

&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; MySQL  localhost:24630 ssl  JS &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; cluster.status&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;clusterName&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;testCluster&quot;&lt;/span&gt;, 
    &lt;span class=&quot;s2&quot;&gt;&quot;defaultReplicaSet&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;name&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;default&quot;&lt;/span&gt;, 
        &lt;span class=&quot;s2&quot;&gt;&quot;primary&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;node-1:24630&quot;&lt;/span&gt;, 
        &lt;span class=&quot;s2&quot;&gt;&quot;ssl&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;REQUIRED&quot;&lt;/span&gt;, 
        &lt;span class=&quot;s2&quot;&gt;&quot;status&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;OK&quot;&lt;/span&gt;, 
        &lt;span class=&quot;s2&quot;&gt;&quot;statusText&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;Cluster is ONLINE and can tolerate up to ONE failure.&quot;&lt;/span&gt;, 
        &lt;span class=&quot;s2&quot;&gt;&quot;topology&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;s2&quot;&gt;&quot;node-1:24630&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;s2&quot;&gt;&quot;address&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;node-1:24630&quot;&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;mode&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;R/W&quot;&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;readReplicas&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{}&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;role&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;HA&quot;&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;status&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;ONLINE&quot;&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;, 
            &lt;span class=&quot;s2&quot;&gt;&quot;node-2:24631&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;s2&quot;&gt;&quot;address&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;node-2:24631&quot;&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;mode&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;R/O&quot;&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;readReplicas&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{}&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;role&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;HA&quot;&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;status&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;ONLINE&quot;&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;, 
            &lt;span class=&quot;s2&quot;&gt;&quot;node-3:24632&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;s2&quot;&gt;&quot;address&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;node-3:24632&quot;&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;mode&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;R/O&quot;&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;readReplicas&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{}&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;role&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;HA&quot;&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;status&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;ONLINE&quot;&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;, 
        &lt;span class=&quot;s2&quot;&gt;&quot;topologyMode&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;Single-Primary&quot;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;, 
    &lt;span class=&quot;s2&quot;&gt;&quot;groupInformationSourceMember&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;node-1:24630&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;安装mysql-router&quot;&gt;安装MySQL router&lt;/h3&gt;

&lt;p&gt;待补充&lt;/p&gt;

&lt;h3 id=&quot;模拟单节点重启&quot;&gt;模拟单节点重启&lt;/h3&gt;

&lt;p&gt;关闭节点&lt;/p&gt;

&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;./node2/stop
dbdeployer global status
&lt;span class=&quot;c&quot;&gt;# Running &quot;status_all&quot; on multi_msb_5_7_29&lt;/span&gt;
MULTIPLE  /Users/qianyin/sandboxes/multi_msb_5_7_29
node1 : node1 on  -  port       24630 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;24630&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
node2 : node2 off  -  port      24630 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;24631&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
node3 : node3 on  -  port       24632 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;24632&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;集群状态&lt;/p&gt;

&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; MySQL  localhost:6447 ssl  JS &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; dba.getCluster&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;.status&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;clusterName&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;testCluster&quot;&lt;/span&gt;, 
    &lt;span class=&quot;s2&quot;&gt;&quot;defaultReplicaSet&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;name&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;default&quot;&lt;/span&gt;, 
        &lt;span class=&quot;s2&quot;&gt;&quot;primary&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;node-1:24630&quot;&lt;/span&gt;, 
        &lt;span class=&quot;s2&quot;&gt;&quot;ssl&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;REQUIRED&quot;&lt;/span&gt;, 
        &lt;span class=&quot;s2&quot;&gt;&quot;status&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;OK_NO_TOLERANCE&quot;&lt;/span&gt;, 
        &lt;span class=&quot;s2&quot;&gt;&quot;statusText&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;Cluster is NOT tolerant to any failures. 1 member is not active&quot;&lt;/span&gt;, 
        &lt;span class=&quot;s2&quot;&gt;&quot;topology&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;s2&quot;&gt;&quot;node-1:24630&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;s2&quot;&gt;&quot;address&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;node-1:24630&quot;&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;mode&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;R/W&quot;&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;readReplicas&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{}&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;role&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;HA&quot;&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;status&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;ONLINE&quot;&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;, 
            &lt;span class=&quot;s2&quot;&gt;&quot;node-2:24631&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;s2&quot;&gt;&quot;address&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;node-2:24631&quot;&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;mode&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;n/a&quot;&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;readReplicas&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{}&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;role&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;HA&quot;&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;shellConnectError&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;MySQL Error 2003 (HY000): Can't connect to MySQL server on 'node-2' (61)&quot;&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;status&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;(MISSING)&quot;&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;, 
            &lt;span class=&quot;s2&quot;&gt;&quot;node-3:24632&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;s2&quot;&gt;&quot;address&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;node-3:24632&quot;&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;mode&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;R/O&quot;&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;readReplicas&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{}&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;role&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;HA&quot;&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;status&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;ONLINE&quot;&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;, 
        &lt;span class=&quot;s2&quot;&gt;&quot;topologyMode&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;Single-Primary&quot;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;, 
    &lt;span class=&quot;s2&quot;&gt;&quot;groupInformationSourceMember&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;node-1:24630&quot;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;启动节点&lt;/p&gt;

&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; ./node2/start
.. sandbox server started
&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; dbdeployer global status
&lt;span class=&quot;c&quot;&gt;# Running &quot;status_all&quot; on multi_msb_5_7_29&lt;/span&gt;
MULTIPLE  /Users/qianyin/sandboxes/multi_msb_5_7_29
node1 : node1 on  -  port       24630 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;24630&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
node2 : node2 on  -  port       24631 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;24631&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
node3 : node3 on  -  port       24632 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;24632&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;查看集群状态&lt;/p&gt;

&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; MySQL  localhost:6447 ssl  JS &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; dba.getCluster&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;.status&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;clusterName&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;testCluster&quot;&lt;/span&gt;, 
    &lt;span class=&quot;s2&quot;&gt;&quot;defaultReplicaSet&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;name&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;default&quot;&lt;/span&gt;, 
        &lt;span class=&quot;s2&quot;&gt;&quot;primary&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;node-1:24630&quot;&lt;/span&gt;, 
        &lt;span class=&quot;s2&quot;&gt;&quot;ssl&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;REQUIRED&quot;&lt;/span&gt;, 
        &lt;span class=&quot;s2&quot;&gt;&quot;status&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;OK_NO_TOLERANCE&quot;&lt;/span&gt;, 
        &lt;span class=&quot;s2&quot;&gt;&quot;statusText&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;Cluster is NOT tolerant to any failures. 1 member is not active&quot;&lt;/span&gt;, 
        &lt;span class=&quot;s2&quot;&gt;&quot;topology&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;s2&quot;&gt;&quot;node-1:24630&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;s2&quot;&gt;&quot;address&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;node-1:24630&quot;&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;mode&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;R/W&quot;&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;readReplicas&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{}&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;role&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;HA&quot;&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;status&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;ONLINE&quot;&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;, 
            &lt;span class=&quot;s2&quot;&gt;&quot;node-2:24631&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;s2&quot;&gt;&quot;address&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;node-2:24631&quot;&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;mode&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;R/W&quot;&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;readReplicas&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{}&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;role&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;HA&quot;&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;status&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;(MISSING)&quot;&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;, 
            &lt;span class=&quot;s2&quot;&gt;&quot;node-3:24632&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;s2&quot;&gt;&quot;address&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;node-3:24632&quot;&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;mode&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;R/O&quot;&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;readReplicas&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{}&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;role&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;HA&quot;&lt;/span&gt;, 
                &lt;span class=&quot;s2&quot;&gt;&quot;status&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;ONLINE&quot;&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;, 
        &lt;span class=&quot;s2&quot;&gt;&quot;topologyMode&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;Single-Primary&quot;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;, 
    &lt;span class=&quot;s2&quot;&gt;&quot;groupInformationSourceMember&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;node-1:24630&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;修复&lt;/p&gt;

&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cluster.removeInstance&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'root@localhost:24631'&lt;/span&gt;,&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;force: &lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;})&lt;/span&gt;  &lt;span class=&quot;c&quot;&gt;#这一步可能会失败，多尝试几次&lt;/span&gt;
cluster.addInstance&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'root@localhost:24631'&lt;/span&gt;,&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'localAddress'&lt;/span&gt;:&lt;span class=&quot;s1&quot;&gt;'localhost:25631'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;})&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;常用运维命令&quot;&gt;常用运维命令&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;组复制状态
    &lt;ul&gt;
      &lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;select * from performance_schema.global_status where variable_name like '%group%';&lt;/code&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;组复制成员
    &lt;ul&gt;
      &lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;select * from performance_schema.replication_group_members;&lt;/code&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;所有节点重启脑裂场景参考如下&quot;&gt;所有节点重启，脑裂场景参考如下&lt;/h3&gt;

&lt;p&gt;https://jeremyxu2010.github.io/2019/05/mysql-innodb-cluster%E5%AE%9E%E6%88%98/&lt;/p&gt;</content><author><name>Nick</name></author><category term="innodb_cluster" /><summary type="html">用dbdeployer 部署3个单节点 dbdeployer deploy multiple 5.7 -n 3 查看节点状态 dbdeployer sandboxes --full-info .------------------.----------.---------.-----------.----------------------.--------.-------.--------. | name | type | version | host | port | flavor | nodes | locked | +------------------+----------+---------+-----------+----------------------+--------+-------+--------+ | multi_msb_5_7_29 | multiple | 5.7.29 | 127.0.0.1 | [24630 24631 24632 ] | mysql | 3 | | '------------------'----------'---------'-----------'----------------------'--------'-------'--------' dbdeployer global status # Running &quot;status_all&quot; on multi_msb_5_7_29 MULTIPLE /Users/qianyin/sandboxes/multi_msb_5_7_29 node1 : node1 on - port 24630 (24630) node2 : node2 on - port 24631 (24631) node3 : node3 on - port 24632 (24632) 下载MySQL-Shell wget https://dev.mysql.com/get/Downloads/MySQL-Shell/mysql-shell-8.0.19-macos10.15-x86-64bit.tar.gz 解压后进入mysql shell 目录 bin目录下就3个文件 -rwxr-xr-x@ 1 qianyin staff 633256 12 17 09:42 mysql-secret-store-keychain* -rwxr-xr-x@ 1 qianyin staff 7957420 12 17 09:42 mysql-secret-store-login-path* -rwxr-xr-x@ 1 qianyin staff 31067132 12 17 09:42 mysqlsh* 我们运行mysqlsh 可以先打\help 看下帮助提示 可以看到支持的模块如下： - dba Used for InnoDB cluster administration. - mysql Support for connecting to MySQL servers using the classic MySQL protocol. - mysqlx Used to work with X Protocol sessions using the MySQL X DevAPI. - os Gives access to functions which allow to interact with the operating system. - shell Gives access to general purpose functions and properties. - sys Gives access to system specific parameters. - util Global object that groups miscellaneous tools like upgrade checker and JSON import. 部署集群我们需要用到dba功能，再查看dba的帮助信息 \? dba 正式配置集群 检查并配置3个数据库实例 mysql-js&amp;gt; \connect root@localhost:24630 MySQL localhost:24630 ssl JS &amp;gt; dba.configureLocalInstance() Configuring local MySQL instance listening at port 24630 for use in an InnoDB cluster... This instance reports its own address as node-1:24630 ERROR: User 'root' can only connect from 'localhost'. New account(s) with proper source address specification to allow remote connection from all instances must be created to manage the cluster. 1) Create remotely usable account for 'root' with same grants and password 2) Create a new admin account for InnoDB cluster with minimal required grants 3) Ignore and continue 4) Cancel Please select an option [1]: Please provide a source address filter for the account (e.g: 192.168.% or % etc) or leave empty and press Enter to cancel. Account Host: % NOTE: Some configuration options need to be fixed: +----------------------------------+---------------+----------------+------------------------------------------------+ | Variable | Current Value | Required Value | Note | +----------------------------------+---------------+----------------+------------------------------------------------+ | binlog_checksum | CRC32 | NONE | Update the server variable and the config file | | enforce_gtid_consistency | OFF | ON | Update the config file and restart the server | | gtid_mode | OFF | ON | Update the config file and restart the server | | log_slave_updates | OFF | ON | Update the config file and restart the server | | master_info_repository | FILE | TABLE | Update the config file and restart the server | | relay_log_info_repository | FILE | TABLE | Update the config file and restart the server | | transaction_write_set_extraction | OFF | XXHASH64 | Update the config file and restart the server | +----------------------------------+---------------+----------------+------------------------------------------------+ Some variables need to be changed, but cannot be done dynamically on the server: an option file is required. Detecting the configuration file... Default file not found at the standard locations. Please specify the path to the MySQL configuration file: /Users/qianyin/sandboxes/multi_msb_5_7_29/node1/my.sandbox.cnf Do you want to perform the required configuration changes? [y/n]: y Cluster admin user 'root'@'%' created. Configuring instance... The instance 'node-1:24630' was configured to be used in an InnoDB cluster. NOTE: MySQL server needs to be restarted for configuration changes to take effect. 依次修改另外2个节点 查看my.cnf 会发现在文件末尾添加了如下配置： binlog_checksum = NONE enforce_gtid_consistency = ON gtid_mode = ON log_slave_updates = ON master_info_repository = TABLE relay_log_info_repository = TABLE transaction_write_set_extraction = XXHASH64 配置完后，检查下 MySQL localhost:24630 ssl JS &amp;gt; dba.checkInstanceConfiguration('root@localhost:24631') Validating local MySQL instance listening at port 24631 for use in an InnoDB cluster... This instance reports its own address as node-2:24631 Checking whether existing tables comply with Group Replication requirements... No incompatible tables detected Checking instance configuration... Instance configuration is compatible with InnoDB cluster The instance 'node-2:24631' is valid to be used in an InnoDB cluster. { &quot;status&quot;: &quot;ok&quot; } 3个节点都显示”status”: “ok” 即可。 创建集群 MySQL localhost:24630 ssl JS &amp;gt; var cluster = dba.createCluster('testCluster',{'localAddress':'localhost:25630'}) A new InnoDB cluster will be created on instance 'localhost:24630'. Disabling super_read_only mode on instance 'node-1:24630'. Validating instance configuration at localhost:24630... This instance reports its own address as node-1:24630 Instance configuration is suitable. WARNING: Instance 'node-1:24630' cannot persist Group Replication configuration since MySQL version 5.7.29 does not support the SET PERSIST command (MySQL version &amp;gt;= 8.0.11 required). Please use the &amp;lt;Dba&amp;gt;.configureLocalInstance() command locally to persist the changes. Creating InnoDB cluster 'testCluster' on 'node-1:24630'... Adding Seed Instance... Cluster successfully created. Use Cluster.addInstance() to add MySQL instances. At least 3 instances are needed for the cluster to be able to withstand up to one server failure. Adding Instances to an InnoDB Cluster **注意：先配置/etc/hosts ** 127.0.0.1 node-1 127.0.0.1 node-2 127.0.0.1 node-3 否则报错： MySQL 127.0.0.1:24630 ssl JS &amp;gt; cluster.addInstance('root@localhost:24631',{'localAddress':'localhost:25631'}) Cluster.addInstance: Unknown MySQL server host 'node-1' (0) (MySQL Error 2005) 添加集群节点 MySQL localhost:24630 ssl JS &amp;gt; cluster.addInstance('root@localhost:24631',{'localAddress':'localhost:25631'}) NOTE: The target instance 'node-2:24631' has not been pre-provisioned (GTID set is empty). The Shell is unable to decide whether incremental state recovery can correctly provision it. The safest and most convenient way to provision a new instance is through automatic clone provisioning, which will completely overwrite the state of 'node-2:24631' with a physical snapshot from an existing cluster member. To use this method by default, set the 'recoveryMethod' option to 'clone'. The incremental state recovery may be safely used if you are sure all updates ever executed in the cluster were done with GTIDs enabled, there are no purged transactions and the new instance contains the same GTID set as the cluster or a subset of it. To use this method by default, set the 'recoveryMethod' option to 'incremental'. Please select a recovery method [I]ncremental recovery/[A]bort (default Incremental recovery): Validating instance configuration at localhost:24631... This instance reports its own address as node-2:24631 Instance configuration is suitable. WARNING: Instance 'node-2:24631' cannot persist Group Replication configuration since MySQL version 5.7.29 does not support the SET PERSIST command (MySQL version &amp;gt;= 8.0.11 required). Please use the &amp;lt;Dba&amp;gt;.configureLocalInstance() command locally to persist the changes. A new instance will be added to the InnoDB cluster. Depending on the amount of data on the cluster this might take from a few seconds to several hours. Adding instance to the cluster... Monitoring recovery process of the new cluster member. Press ^C to stop monitoring and let it continue in background. State recovery already finished for 'node-2:24631' WARNING: Instance 'node-1:24630' cannot persist configuration since MySQL version 5.7.29 does not support the SET PERSIST command (MySQL version &amp;gt;= 8.0.11 required). Please use the &amp;lt;Dba&amp;gt;.configureLocalInstance() command locally to persist the changes. The instance 'localhost:24631' was successfully added to the cluster. MySQL localhost:24630 ssl JS &amp;gt; cluster.addInstance('root@localhost:24632',{'localAddress':'localhost:25632'}) NOTE: The target instance 'node-3:24632' has not been pre-provisioned (GTID set is empty). The Shell is unable to decide whether incremental state recovery can correctly provision it. The safest and most convenient way to provision a new instance is through automatic clone provisioning, which will completely overwrite the state of 'node-3:24632' with a physical snapshot from an existing cluster member. To use this method by default, set the 'recoveryMethod' option to 'clone'. The incremental state recovery may be safely used if you are sure all updates ever executed in the cluster were done with GTIDs enabled, there are no purged transactions and the new instance contains the same GTID set as the cluster or a subset of it. To use this method by default, set the 'recoveryMethod' option to 'incremental'. Please select a recovery method [I]ncremental recovery/[A]bort (default Incremental recovery): Validating instance configuration at localhost:24632... This instance reports its own address as node-3:24632 Instance configuration is suitable. WARNING: Instance 'node-3:24632' cannot persist Group Replication configuration since MySQL version 5.7.29 does not support the SET PERSIST command (MySQL version &amp;gt;= 8.0.11 required). Please use the &amp;lt;Dba&amp;gt;.configureLocalInstance() command locally to persist the changes. A new instance will be added to the InnoDB cluster. Depending on the amount of data on the cluster this might take from a few seconds to several hours. Adding instance to the cluster... Monitoring recovery process of the new cluster member. Press ^C to stop monitoring and let it continue in background. State recovery already finished for 'node-3:24632' WARNING: Instance 'node-1:24630' cannot persist configuration since MySQL version 5.7.29 does not support the SET PERSIST command (MySQL version &amp;gt;= 8.0.11 required). Please use the &amp;lt;Dba&amp;gt;.configureLocalInstance() command locally to persist the changes. WARNING: Instance 'node-2:24631' cannot persist configuration since MySQL version 5.7.29 does not support the SET PERSIST command (MySQL version &amp;gt;= 8.0.11 required). Please use the &amp;lt;Dba&amp;gt;.configureLocalInstance() command locally to persist the changes. The instance 'localhost:24632' was successfully added to the cluster. 查看cluster 状态 MySQL localhost:24630 ssl JS &amp;gt; cluster.status() { &quot;clusterName&quot;: &quot;testCluster&quot;, &quot;defaultReplicaSet&quot;: { &quot;name&quot;: &quot;default&quot;, &quot;primary&quot;: &quot;node-1:24630&quot;, &quot;ssl&quot;: &quot;REQUIRED&quot;, &quot;status&quot;: &quot;OK&quot;, &quot;statusText&quot;: &quot;Cluster is ONLINE and can tolerate up to ONE failure.&quot;, &quot;topology&quot;: { &quot;node-1:24630&quot;: { &quot;address&quot;: &quot;node-1:24630&quot;, &quot;mode&quot;: &quot;R/W&quot;, &quot;readReplicas&quot;: {}, &quot;role&quot;: &quot;HA&quot;, &quot;status&quot;: &quot;ONLINE&quot; }, &quot;node-2:24631&quot;: { &quot;address&quot;: &quot;node-2:24631&quot;, &quot;mode&quot;: &quot;R/O&quot;, &quot;readReplicas&quot;: {}, &quot;role&quot;: &quot;HA&quot;, &quot;status&quot;: &quot;ONLINE&quot; }, &quot;node-3:24632&quot;: { &quot;address&quot;: &quot;node-3:24632&quot;, &quot;mode&quot;: &quot;R/O&quot;, &quot;readReplicas&quot;: {}, &quot;role&quot;: &quot;HA&quot;, &quot;status&quot;: &quot;ONLINE&quot; } }, &quot;topologyMode&quot;: &quot;Single-Primary&quot; }, &quot;groupInformationSourceMember&quot;: &quot;node-1:24630&quot; 安装MySQL router 待补充 模拟单节点重启 关闭节点 ./node2/stop dbdeployer global status # Running &quot;status_all&quot; on multi_msb_5_7_29 MULTIPLE /Users/qianyin/sandboxes/multi_msb_5_7_29 node1 : node1 on - port 24630 (24630) node2 : node2 off - port 24630 (24631) node3 : node3 on - port 24632 (24632) 集群状态 MySQL localhost:6447 ssl JS &amp;gt; dba.getCluster().status() { &quot;clusterName&quot;: &quot;testCluster&quot;, &quot;defaultReplicaSet&quot;: { &quot;name&quot;: &quot;default&quot;, &quot;primary&quot;: &quot;node-1:24630&quot;, &quot;ssl&quot;: &quot;REQUIRED&quot;, &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures. 1 member is not active&quot;, &quot;topology&quot;: { &quot;node-1:24630&quot;: { &quot;address&quot;: &quot;node-1:24630&quot;, &quot;mode&quot;: &quot;R/W&quot;, &quot;readReplicas&quot;: {}, &quot;role&quot;: &quot;HA&quot;, &quot;status&quot;: &quot;ONLINE&quot; }, &quot;node-2:24631&quot;: { &quot;address&quot;: &quot;node-2:24631&quot;, &quot;mode&quot;: &quot;n/a&quot;, &quot;readReplicas&quot;: {}, &quot;role&quot;: &quot;HA&quot;, &quot;shellConnectError&quot;: &quot;MySQL Error 2003 (HY000): Can't connect to MySQL server on 'node-2' (61)&quot;, &quot;status&quot;: &quot;(MISSING)&quot; }, &quot;node-3:24632&quot;: { &quot;address&quot;: &quot;node-3:24632&quot;, &quot;mode&quot;: &quot;R/O&quot;, &quot;readReplicas&quot;: {}, &quot;role&quot;: &quot;HA&quot;, &quot;status&quot;: &quot;ONLINE&quot; } }, &quot;topologyMode&quot;: &quot;Single-Primary&quot; }, &quot;groupInformationSourceMember&quot;: &quot;node-1:24630&quot; } 启动节点 &amp;gt; ./node2/start .. sandbox server started &amp;gt; dbdeployer global status # Running &quot;status_all&quot; on multi_msb_5_7_29 MULTIPLE /Users/qianyin/sandboxes/multi_msb_5_7_29 node1 : node1 on - port 24630 (24630) node2 : node2 on - port 24631 (24631) node3 : node3 on - port 24632 (24632) 查看集群状态 MySQL localhost:6447 ssl JS &amp;gt; dba.getCluster().status() { &quot;clusterName&quot;: &quot;testCluster&quot;, &quot;defaultReplicaSet&quot;: { &quot;name&quot;: &quot;default&quot;, &quot;primary&quot;: &quot;node-1:24630&quot;, &quot;ssl&quot;: &quot;REQUIRED&quot;, &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures. 1 member is not active&quot;, &quot;topology&quot;: { &quot;node-1:24630&quot;: { &quot;address&quot;: &quot;node-1:24630&quot;, &quot;mode&quot;: &quot;R/W&quot;, &quot;readReplicas&quot;: {}, &quot;role&quot;: &quot;HA&quot;, &quot;status&quot;: &quot;ONLINE&quot; }, &quot;node-2:24631&quot;: { &quot;address&quot;: &quot;node-2:24631&quot;, &quot;mode&quot;: &quot;R/W&quot;, &quot;readReplicas&quot;: {}, &quot;role&quot;: &quot;HA&quot;, &quot;status&quot;: &quot;(MISSING)&quot; }, &quot;node-3:24632&quot;: { &quot;address&quot;: &quot;node-3:24632&quot;, &quot;mode&quot;: &quot;R/O&quot;, &quot;readReplicas&quot;: {}, &quot;role&quot;: &quot;HA&quot;, &quot;status&quot;: &quot;ONLINE&quot; } }, &quot;topologyMode&quot;: &quot;Single-Primary&quot; }, &quot;groupInformationSourceMember&quot;: &quot;node-1:24630&quot; 修复 cluster.removeInstance('root@localhost:24631',{force: true}) #这一步可能会失败，多尝试几次 cluster.addInstance('root@localhost:24631',{'localAddress':'localhost:25631'}) 常用运维命令 组复制状态 select * from performance_schema.global_status where variable_name like '%group%'; 组复制成员 select * from performance_schema.replication_group_members; 所有节点重启，脑裂场景参考如下 https://jeremyxu2010.github.io/2019/05/mysql-innodb-cluster%E5%AE%9E%E6%88%98/</summary></entry><entry><title type="html">MySQL运维SQL&amp;amp;工具 手册</title><link href="http://localhost:4000/%E8%BF%90%E7%BB%B4/mysql/2020/04/18/mysql%E8%BF%90%E7%BB%B4SQL&%E5%B7%A5%E5%85%B7%E9%9B%86%E9%94%A6/" rel="alternate" type="text/html" title="MySQL运维SQL&amp;工具 手册" /><published>2020-04-18T00:00:00+08:00</published><updated>2020-04-18T00:00:00+08:00</updated><id>http://localhost:4000/%E8%BF%90%E7%BB%B4/mysql/2020/04/18/mysql%E8%BF%90%E7%BB%B4SQL&amp;%E5%B7%A5%E5%85%B7%E9%9B%86%E9%94%A6</id><content type="html" xml:base="http://localhost:4000/%E8%BF%90%E7%BB%B4/mysql/2020/04/18/mysql%E8%BF%90%E7%BB%B4SQL&amp;%E5%B7%A5%E5%85%B7%E9%9B%86%E9%94%A6/">&lt;h3 id=&quot;连接&quot;&gt;连接&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;如何不需要密码的登录，直接mysql&lt;/strong&gt;&lt;/p&gt;

    &lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;pi&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;mysql&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;]&lt;/span&gt;  &lt;span class=&quot;s&quot;&gt;--表示： 只有mysql命令才能免密码&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;user=root&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;password=123&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;socket=/tmp/mysql.sock&lt;/span&gt;
   
&lt;span class=&quot;pi&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;mysqladmin&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;--表示： 只有mysqladmin命令才能免密码&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;user=root&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;password=123&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;socket=/tmp/mysql.sock&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;mysqldump&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;--表示： 只有mysqldump命令才能免密码&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;user=root&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;password=123&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;socket=/tmp/mysql.sock&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;client&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;]&lt;/span&gt;   &lt;span class=&quot;s&quot;&gt;--表示：只要是客户端的命令，都是可以免密码的&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;user=root&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;password=123&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;socket=/tmp/mysql.sock&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;mysql如何查看用户名密码&quot;&gt;MySQL如何查看用户名密码&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;MySQL5.7.6之前&lt;/p&gt;

    &lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;show&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;grants&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;host&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Password&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;MySQL5.7.6+&lt;/p&gt;

    &lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;host&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;authentication_string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;password_lifetime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;password_expired&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;password_last_changed&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mysql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;user&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'xxx'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;information_schema相关&quot;&gt;information_schema相关&lt;/h3&gt;

&lt;h4 id=&quot;如何在线kill掉满足某种条件的session&quot;&gt;如何在线kill掉满足某种条件的session&lt;/h4&gt;

&lt;p&gt;待补充&lt;/p&gt;

&lt;h4 id=&quot;processlist&quot;&gt;PROCESSLIST&lt;/h4&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;分析出当前连接过来的客户端ip的分布情况&lt;/strong&gt;&lt;/p&gt;

    &lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;substring_index&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;host&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;':'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;appip&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;count&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;information_schema&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PROCESSLIST&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;group&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;appip&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;count&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;desc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;分析处于Sleep状态的连接分布情况&lt;/strong&gt;&lt;/p&gt;

    &lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;substring_index&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;host&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;':'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;appip&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;count&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;information_schema&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PROCESSLIST&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;COMMAND&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'Sleep'&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;group&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;appip&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;count&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;desc&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;分析哪些DB访问的比较多&lt;/strong&gt;&lt;/p&gt;

    &lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;DB&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;count&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;information_schema&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PROCESSLIST&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;COMMAND&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'Sleep'&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;group&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;DB&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;count&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;desc&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;分析哪些用户访问的比较多&lt;/strong&gt;&lt;/p&gt;

    &lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;user&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;count&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;information_schema&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PROCESSLIST&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;COMMAND&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'Sleep'&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;group&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;user&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;count&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;desc&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;tables&quot;&gt;Tables&lt;/h4&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;列出大于10G以上的表&lt;/strong&gt;&lt;/p&gt;

    &lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TABLE_SCHEMA&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;TABLE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TABLE_ROWS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ROUND&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;INDEX_LENGTH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DATA_FREE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DATA_LENGTH&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;size_G&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;information_schema&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tables&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ROUND&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;INDEX_LENGTH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DATA_FREE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DATA_LENGTH&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;size_G&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;desc&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;performance_schema相关&quot;&gt;performance_schema相关&lt;/h3&gt;

&lt;h4 id=&quot;performance_schema-状态概览&quot;&gt;performance_schema 状态概览&lt;/h4&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;SHOW&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;VARIABLES&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;LIKE&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'perf%'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;SHOW&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;STATUS&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;LIKE&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'perf%'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;SHOW&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ENGINE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PERFORMANCE_SCHEMA&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;STATUS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;如何查看每个threads当前session变量的值&quot;&gt;如何查看每个threads当前session变量的值&lt;/h4&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;performance_schema&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;variables_by_thread&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;THREAD_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PROCESSLIST_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PROCESSLIST_USER&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PROCESSLIST_HOST&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PROCESSLIST_COMMAND&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PROCESSLIST_STATE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;performance_schema&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;threads&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PROCESSLIST_USER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'NULL'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;THREAD_ID&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;THREAD_ID&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;VARIABLE_NAME&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'sql_safe_updates'&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;top-sql-相关&quot;&gt;TOP SQL 相关&lt;/h4&gt;

&lt;blockquote&gt;
  &lt;p&gt;能够解决什么问题： 可以找到某个表是否还有业务访问？
能够解决什么问题： 可以确定某个库，某个表的业务是否迁移干净？
能够解决什么问题： 可以用于分析业务是否异常？
能够解决什么问题： 根据TopN 可以分析压力？
能够解决什么问题： 可以用于分析哪些表是热点数据，这些TopN的表才是值得优化的表。只要每一条语句快0.01ms，那么1亿条呢？&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;一个实例中查询最多的TopN SQL&lt;/strong&gt;&lt;/p&gt;

    &lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;SCHEMA_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DIGEST_TEXT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;COUNT_STAR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FIRST_SEEN&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LAST_SEEN&lt;/span&gt;  &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;performance_schema&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;events_statements_summary_by_digest&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;DIGEST_TEXT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;like&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'select%'&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;DIGEST_TEXT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;like&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'%SESSION%'&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;COUNT_STAR&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;desc&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;limit&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;G&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;一个实例中写入最多的TopN SQL&lt;/strong&gt;&lt;/p&gt;

    &lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;SCHEMA_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DIGEST_TEXT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;COUNT_STAR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FIRST_SEEN&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LAST_SEEN&lt;/span&gt;  &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;performance_schema&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;events_statements_summary_by_digest&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;DIGEST_TEXT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;like&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'insert%'&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;or&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;DIGEST_TEXT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;like&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'update%'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;or&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;DIGEST_TEXT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;like&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'delete%'&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;or&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;DIGEST_TEXT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;like&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'replace%'&lt;/span&gt;  &lt;span class=&quot;k&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;COUNT_STAR&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;desc&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;limit&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;G&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;table-io-相关的监控&quot;&gt;Table IO 相关的监控&lt;/h4&gt;

&lt;h5 id=&quot;库级别&quot;&gt;库级别&lt;/h5&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;如何查看一个MySQL实例中哪个库的all latency时间最大&lt;/strong&gt;&lt;/p&gt;

    &lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;  
  
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ul&gt;</content><author><name>Nick</name></author><category term="运维" /><summary type="html">连接 如何不需要密码的登录，直接mysql [mysql] --表示： 只有mysql命令才能免密码 user=root password=123 socket=/tmp/mysql.sock [mysqladmin] --表示： 只有mysqladmin命令才能免密码 user=root password=123 socket=/tmp/mysql.sock [mysqldump] --表示： 只有mysqldump命令才能免密码 user=root password=123 socket=/tmp/mysql.sock [client] --表示：只要是客户端的命令，都是可以免密码的 user=root password=123 socket=/tmp/mysql.sock MySQL如何查看用户名密码 MySQL5.7.6之前 1. show grants for $user; 2. select host,user,Password from user; MySQL5.7.6+ select host,user,authentication_string,password_lifetime,password_expired,password_last_changed from mysql.user where user='xxx'; information_schema相关 如何在线kill掉满足某种条件的session 待补充 PROCESSLIST 分析出当前连接过来的客户端ip的分布情况 select substring_index(host,':', 1) as appip ,count(*) as count from information_schema.PROCESSLIST group by appip order by count desc; 分析处于Sleep状态的连接分布情况 select substring_index(host,':', 1) as appip ,count(*) as count from information_schema.PROCESSLIST where COMMAND='Sleep' group by appip order by count desc ; 分析哪些DB访问的比较多 select DB ,count(*) as count from information_schema.PROCESSLIST where COMMAND='Sleep' group by DB order by count desc ; 分析哪些用户访问的比较多 select user ,count(*) as count from information_schema.PROCESSLIST where COMMAND='Sleep' group by user order by count desc ; Tables 列出大于10G以上的表 select TABLE_SCHEMA,TABLE_NAME,TABLE_ROWS,ROUND((INDEX_LENGTH+DATA_FREE+DATA_LENGTH)/1024/1024/1024) as size_G from information_schema.tables where ROUND((INDEX_LENGTH+DATA_FREE+DATA_LENGTH)/1024/1024/1024) &amp;gt; 10 order by size_G desc ; performance_schema相关 performance_schema 状态概览 SHOW VARIABLES LIKE 'perf%'; SHOW STATUS LIKE 'perf%'; SHOW ENGINE PERFORMANCE_SCHEMA STATUS; 如何查看每个threads当前session变量的值 select * from performance_schema.variables_by_thread as a,(select THREAD_ID,PROCESSLIST_ID,PROCESSLIST_USER,PROCESSLIST_HOST,PROCESSLIST_COMMAND,PROCESSLIST_STATE from performance_schema.threads where PROCESSLIST_USER&amp;lt;&amp;gt;'NULL') as b where a.THREAD_ID = b.THREAD_ID and a.VARIABLE_NAME = 'sql_safe_updates' TOP SQL 相关 能够解决什么问题： 可以找到某个表是否还有业务访问？ 能够解决什么问题： 可以确定某个库，某个表的业务是否迁移干净？ 能够解决什么问题： 可以用于分析业务是否异常？ 能够解决什么问题： 根据TopN 可以分析压力？ 能够解决什么问题： 可以用于分析哪些表是热点数据，这些TopN的表才是值得优化的表。只要每一条语句快0.01ms，那么1亿条呢？ 一个实例中查询最多的TopN SQL select SCHEMA_NAME,DIGEST_TEXT,COUNT_STAR,FIRST_SEEN,LAST_SEEN from performance_schema.events_statements_summary_by_digest where DIGEST_TEXT like 'select%' and DIGEST_TEXT not like '%SESSION%' order by COUNT_STAR desc limit 10\G 一个实例中写入最多的TopN SQL select SCHEMA_NAME,DIGEST_TEXT,COUNT_STAR,FIRST_SEEN,LAST_SEEN from performance_schema.events_statements_summary_by_digest where DIGEST_TEXT like 'insert%' or DIGEST_TEXT like 'update%'or DIGEST_TEXT like 'delete%' or DIGEST_TEXT like 'replace%' order by COUNT_STAR desc limit 10\G Table IO 相关的监控 库级别 如何查看一个MySQL实例中哪个库的all latency时间最大</summary></entry><entry><title type="html">用innobackupex实现加密备份</title><link href="http://localhost:4000/mysql/2020/04/18/innobackupex_encrypt/" rel="alternate" type="text/html" title="用innobackupex实现加密备份" /><published>2020-04-18T00:00:00+08:00</published><updated>2020-04-18T00:00:00+08:00</updated><id>http://localhost:4000/mysql/2020/04/18/innobackupex_encrypt</id><content type="html" xml:base="http://localhost:4000/mysql/2020/04/18/innobackupex_encrypt/">&lt;h3 id=&quot;安装innobackupex&quot;&gt;安装innobackupex&lt;/h3&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;yum install https://repo.percona.com/yum/percona-release-latest.noarch.rpm
yum install percona-xtrabackup-24
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;mysql创建备份用户&quot;&gt;MySQL创建备份用户&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&quot;language-mysql&quot;&gt;GRANT RELOAD, LOCK TABLES, REPLICATION CLIENT ON *.* TO 'xbackupopr'@'%' IDENTIFIED BY 'UFfrBrtyv_cxR50C';
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;生成encrypt-key可不执行直接用脚本中的key&quot;&gt;生成encrypt-key（可不执行，直接用脚本中的key）&lt;/h3&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;openssl enc -aes-256-cbc -pass pass:Password -P -md sha1 | grep iv | cut -d'=' -f2 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;脚本&quot;&gt;脚本&lt;/h3&gt;

&lt;div class=&quot;language-python highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/usr/bin/python&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#coding:UTF-8&lt;/span&gt;

&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;os&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sys&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;commands&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;innobackupex&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;'/usr/bin/innobackupex'&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# 全备函数&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;full_backup&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;host&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;password&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;full_backup_dir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;week_of_dir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;backup_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;os&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;s --host=&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;s --port=&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;s --user=&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;s --password=&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;s --encrypt=AES256 --encrypt-key=CCD0C542F643163CBF4734362FC917C7 --extra-lsndir=&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;s --no-timestamp &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;s &amp;gt; &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;s 2&amp;gt;&amp;amp;1&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;innobackupex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;host&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;password&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;week_of_dir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;full_backup_dir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;backup_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# 增备函数&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;incr_backup&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;host&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;password&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;incr_backup_dir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;incremental_lsn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;extra_lsndir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;backup_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;os&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;s --incremental &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;s  --incremental-lsn=&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;s --host=&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;s --port=&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;s --user=&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;s --password=&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;s  --extra-lsndir=&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;s --encrypt=AES256 --encrypt-key=CCD0C542F643163CBF4734362FC917C7 &amp;gt; &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;s 2&amp;gt;&amp;amp;1&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;innobackupex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;incr_backup_dir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;incremental_lsn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;host&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;password&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;extra_lsndir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;backup_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# 主函数&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;__name__&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;'__main__'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;host&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;127.0.0.1&quot;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;port&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;'3306'&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;'xbackupopr'&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;password&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;'UFfrBrtyv_cxR50C'&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;backup_dir&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;'/data/backup/'&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;defaults_file&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;'/data/my3306/my.cnf'&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;wday&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;localtime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tm_wday&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;week_of_dir&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;backup_dir&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;strftime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;U&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;localtime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;full_backup_dir&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;week_of_dir&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;'/full'&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;backup_log&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;/tmp/backup.log&quot;&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;# 增备寻找最新的上一次备份的基准目录&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;base_backup_dir&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commands&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;getoutput&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;'find '&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;week_of_dir&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;' -mindepth 1 -maxdepth 1 -type d -printf &quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;P&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;  | sort -nr | head -1'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
    &lt;span class=&quot;c&quot;&gt;# 获取最新的lsn,xtrabackup_checkpoints文件在每次全备或者增备后会被覆盖&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;os&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;exists&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;week_of_dir&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;'/xtrabackup_checkpoints'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;incremental_lsn&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commands&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;getoutput&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;'cat '&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;week_of_dir&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;'/xtrabackup_checkpoints| grep to_lsn | cut -d&quot;=&quot; -f2|sed -e &quot;s/^[ ]*//g&quot;'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;incremental_lsn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;'xtrabackup_checkpoints not exists.Maybe full_backup progress not running yet.'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;# 探测mysql实例是否存活，如果存活继续下面的程序执行，如果不存活则直接退出程序&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;mysql_stat&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commands&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;getoutput&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;'/bin/netstat -anp|grep '&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;port&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;' |grep -v unix|wc -l'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mysql_stat&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;print&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;mysql实例存活，可进行备份操作！&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;print&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;mysql实例不存在，备份操作终止！&quot;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;sys&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;exit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;# 每周生成一个周备份目录，全备和增备目录都放在此目录下面&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;os&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;exists&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;week_of_dir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;print&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;周备份目录已经生成，可进行相应的全备或者增量备份&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;print&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;周备份目录未产生，创建周备份目录...&quot;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;os&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;makedirs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;week_of_dir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;# 判断是否周日，如果是周日，直接进行全备，如果不是周日，先检查全备是否存在，不存在则进行全备，存在则进行增备&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;print&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;备份开始&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;wday&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;full_backup&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;host&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;password&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;full_backup_dir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;week_of_dir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;backup_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;os&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;exists&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;full_backup_dir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;incr_backup&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;host&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;password&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;week_of_dir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;incremental_lsn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;week_of_dir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;backup_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;full_backup&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;host&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;password&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;full_backup_dir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;week_of_dir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;backup_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;print&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;备份结束，判断备份是否成功&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;try&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;with&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;/tmp/backup.log&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;seek&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;14&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;backup_results&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;readline&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;strip&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;backup_results&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;completed OK!&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;print&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;备份成功&quot;&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;print&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;备份失败&quot;&lt;/span&gt;            
    &lt;span class=&quot;k&quot;&gt;except&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;sys&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;exit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;# 备份保留4周&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;os&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;find &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;s -mindepth 1 -maxdepth 1 -type d -ctime +28 -exec rm -rf  {} &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;backup_dir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;备份解密&quot;&gt;备份解密&lt;/h3&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;innobackupex  &lt;span class=&quot;nt&quot;&gt;--decrypt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;AES256 &lt;span class=&quot;nt&quot;&gt;--encrypt-key&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;CCD0C542F643163CBF4734362FC917C7  /data/backup/42/full/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name>Nick</name></author><category term="pt-tools" /><summary type="html">安装innobackupex yum install https://repo.percona.com/yum/percona-release-latest.noarch.rpm yum install percona-xtrabackup-24 MySQL创建备份用户 GRANT RELOAD, LOCK TABLES, REPLICATION CLIENT ON *.* TO 'xbackupopr'@'%' IDENTIFIED BY 'UFfrBrtyv_cxR50C'; 生成encrypt-key（可不执行，直接用脚本中的key） openssl enc -aes-256-cbc -pass pass:Password -P -md sha1 | grep iv | cut -d'=' -f2 脚本 #!/usr/bin/python #coding:UTF-8 import os,time,sys,commands innobackupex = '/usr/bin/innobackupex' # 全备函数 def full_backup(host, port, user, password, full_backup_dir,week_of_dir, backup_log): os.system(&quot;%s --host=%s --port=%s --user=%s --password=%s --encrypt=AES256 --encrypt-key=CCD0C542F643163CBF4734362FC917C7 --extra-lsndir=%s --no-timestamp %s &amp;gt; %s 2&amp;gt;&amp;amp;1&quot; %(innobackupex,host, port, user, password, week_of_dir,full_backup_dir, backup_log)) # 增备函数 def incr_backup(host, port, user, password, incr_backup_dir, incremental_lsn,extra_lsndir,backup_log): os.system(&quot;%s --incremental %s --incremental-lsn=%s --host=%s --port=%s --user=%s --password=%s --extra-lsndir=%s --encrypt=AES256 --encrypt-key=CCD0C542F643163CBF4734362FC917C7 &amp;gt; %s 2&amp;gt;&amp;amp;1&quot; %(innobackupex,incr_backup_dir,incremental_lsn,host,port,user,password,extra_lsndir,backup_log)) # 主函数 if __name__ == '__main__': host = &quot;127.0.0.1&quot; port = '3306' user = 'xbackupopr' password = 'UFfrBrtyv_cxR50C' backup_dir = '/data/backup/' defaults_file = '/data/my3306/my.cnf' wday = time.localtime().tm_wday week_of_dir = backup_dir + time.strftime(&quot;%U&quot;, time.localtime()) full_backup_dir = week_of_dir + '/full' backup_log = &quot;/tmp/backup.log&quot; # 增备寻找最新的上一次备份的基准目录 base_backup_dir = commands.getoutput('find ' + week_of_dir + ' -mindepth 1 -maxdepth 1 -type d -printf &quot;%P\n&quot; | sort -nr | head -1') # 获取最新的lsn,xtrabackup_checkpoints文件在每次全备或者增备后会被覆盖 if os.path.exists(week_of_dir + '/xtrabackup_checkpoints'): incremental_lsn = commands.getoutput('cat ' + week_of_dir + '/xtrabackup_checkpoints| grep to_lsn | cut -d&quot;=&quot; -f2|sed -e &quot;s/^[ ]*//g&quot;') print(incremental_lsn) else: print('xtrabackup_checkpoints not exists.Maybe full_backup progress not running yet.') # 探测mysql实例是否存活，如果存活继续下面的程序执行，如果不存活则直接退出程序 mysql_stat = commands.getoutput('/bin/netstat -anp|grep ' + port + ' |grep -v unix|wc -l') if mysql_stat &amp;gt;= 1: print &quot;mysql实例存活，可进行备份操作！&quot; else: print &quot;mysql实例不存在，备份操作终止！&quot; sys.exit() # 每周生成一个周备份目录，全备和增备目录都放在此目录下面 if os.path.exists(week_of_dir): print &quot;周备份目录已经生成，可进行相应的全备或者增量备份&quot; else: print &quot;周备份目录未产生，创建周备份目录...&quot; os.makedirs(week_of_dir) # 判断是否周日，如果是周日，直接进行全备，如果不是周日，先检查全备是否存在，不存在则进行全备，存在则进行增备 print &quot;备份开始&quot; if wday == 6: full_backup(host, port, user, password, full_backup_dir, week_of_dir,backup_log) else: if os.path.exists(full_backup_dir): incr_backup(host, port, user, password, week_of_dir,incremental_lsn,week_of_dir,backup_log) else: full_backup(host, port, user, password, full_backup_dir,week_of_dir, backup_log) print &quot;备份结束，判断备份是否成功&quot; try: with open(&quot;/tmp/backup.log&quot;) as f: f.seek(-14, 2) backup_results = f.readline().strip() if backup_results == &quot;completed OK!&quot;: print &quot;备份成功&quot; else: print &quot;备份失败&quot; except Error: sys.exit() # 备份保留4周 os.system(&quot;find %s -mindepth 1 -maxdepth 1 -type d -ctime +28 -exec rm -rf {} \;&quot; %backup_dir) 备份解密 innobackupex --decrypt=AES256 --encrypt-key=CCD0C542F643163CBF4734362FC917C7 /data/backup/42/full/</summary></entry><entry><title type="html">03 | 事务隔离：为什么你改了我还看不见？</title><link href="http://localhost:4000/mysql/2019/01/03/MySQL45-3/" rel="alternate" type="text/html" title="03 | 事务隔离：为什么你改了我还看不见？" /><published>2019-01-03T00:00:00+08:00</published><updated>2019-01-03T00:00:00+08:00</updated><id>http://localhost:4000/mysql/2019/01/03/MySQL45-3</id><content type="html" xml:base="http://localhost:4000/mysql/2019/01/03/MySQL45-3/">&lt;!-- more --&gt;

&lt;p&gt;&lt;img src=&quot;/downloads/image-20200428221235431.png&quot; alt=&quot;image-20200428221235431&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/downloads/image-20200428221239973.png&quot; alt=&quot;image-20200428221239973&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/downloads/image-20200428221247877.png&quot; alt=&quot;image-20200428221247877&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/downloads/image-20200428221253683.png&quot; alt=&quot;image-20200428221253683&quot; /&gt;&lt;/p&gt;</content><author><name>Nick</name></author><category term="丁奇MySQL45讲" /><summary type="html"></summary></entry><entry><title type="html">02 | 日志系统：一条SQL更新语句是如何执行的？</title><link href="http://localhost:4000/mysql/2019/01/02/MySQL45-2/" rel="alternate" type="text/html" title="02 | 日志系统：一条SQL更新语句是如何执行的？" /><published>2019-01-02T00:00:00+08:00</published><updated>2019-01-02T00:00:00+08:00</updated><id>http://localhost:4000/mysql/2019/01/02/MySQL45-2</id><content type="html" xml:base="http://localhost:4000/mysql/2019/01/02/MySQL45-2/">&lt;!-- more --&gt;

&lt;p&gt;&lt;img src=&quot;/downloads/image-20200428220306271.png&quot; alt=&quot;image-20200428220306271&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/downloads/image-20200428220313057.png&quot; alt=&quot;image-20200428220313057&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/downloads/image-20200428220319174.png&quot; alt=&quot;image-20200428220319174&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/downloads/image-20200428220326008.png&quot; alt=&quot;image-20200428220326008&quot; /&gt;&lt;/p&gt;</content><author><name>Nick</name></author><category term="丁奇MySQL45讲" /><summary type="html"></summary></entry><entry><title type="html">01 | 基础架构：一条SQL查询语句是如何执行的？</title><link href="http://localhost:4000/mysql/2019/01/01/MySQL45-1/" rel="alternate" type="text/html" title="01 | 基础架构：一条SQL查询语句是如何执行的？" /><published>2019-01-01T00:00:00+08:00</published><updated>2019-01-01T00:00:00+08:00</updated><id>http://localhost:4000/mysql/2019/01/01/MySQL45-1</id><content type="html" xml:base="http://localhost:4000/mysql/2019/01/01/MySQL45-1/">&lt;!-- more --&gt;

&lt;p&gt;&lt;img src=&quot;/downloads/image-20200428204010645.png&quot; alt=&quot;image-20200428204010645&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/downloads/image-20200428204016303.png&quot; alt=&quot;image-20200428204016303&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/downloads/image-20200428204022093.png&quot; alt=&quot;image-20200428204022093&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/downloads/image-20200428204028445.png&quot; alt=&quot;image-20200428204028445&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/downloads/image-20200428204033999.png&quot; alt=&quot;image-20200428204033999&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/downloads/image-20200428204041180.png&quot; alt=&quot;image-20200428204041180&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/downloads/image-20200428204051115.png&quot; alt=&quot;image-20200428204051115&quot; /&gt;&lt;/p&gt;</content><author><name>Nick</name></author><category term="丁奇MySQL45讲" /><summary type="html"></summary></entry><entry><title type="html">mongodb change stream 功能介绍</title><link href="http://localhost:4000/mongodb/2018/05/01/mongodb_change_stream/" rel="alternate" type="text/html" title="mongodb change stream 功能介绍" /><published>2018-05-01T00:00:00+08:00</published><updated>2018-05-01T00:00:00+08:00</updated><id>http://localhost:4000/mongodb/2018/05/01/mongodb_change_stream</id><content type="html" xml:base="http://localhost:4000/mongodb/2018/05/01/mongodb_change_stream/">&lt;h3 id=&quot;什么是-change-stream&quot;&gt;什么是 Change Stream&lt;/h3&gt;

&lt;p&gt;Change Stream 是 MongoDB 用于实现变更追踪的解决方案，类似于关系数据库的触发器，但原理不完全相同:&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt; &lt;/th&gt;
      &lt;th&gt;Change Stream&lt;/th&gt;
      &lt;th&gt;触发器&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;触发方式&lt;/td&gt;
      &lt;td&gt;异步&lt;/td&gt;
      &lt;td&gt;同步&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;触发位置&lt;/td&gt;
      &lt;td&gt;应用回调事件&lt;/td&gt;
      &lt;td&gt;数据库触发器&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;触发次数&lt;/td&gt;
      &lt;td&gt;每个订阅事件的客户端&lt;/td&gt;
      &lt;td&gt;1次&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;故障恢复&lt;/td&gt;
      &lt;td&gt;从上次断点重新触发&lt;/td&gt;
      &lt;td&gt;事务回滚&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h3 id=&quot;change-stream-的实现原理&quot;&gt;Change Stream 的实现原理&lt;/h3&gt;

&lt;p&gt;Change Stream 是基于 oplog 实现的。它在 oplog 上开启一个 tailable cursor 来追踪所有复制集上的变更操作，最终调用应用中定义的回调函数。&lt;/p&gt;

&lt;p&gt;被追踪的变更事件主要包括:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;insert/update/delete:插入、更新、删除;&lt;/li&gt;
  &lt;li&gt;drop:集合被删除;&lt;/li&gt;
  &lt;li&gt;rename:集合被重命名;&lt;/li&gt;
  &lt;li&gt;dropDatabase:数据库被删除;&lt;/li&gt;
  &lt;li&gt;invalidate:drop/rename/dropDatabase将导致invalidate被触发， 并关闭 change stream;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;change-stream-与可重复读&quot;&gt;Change Stream 与可重复读&lt;/h3&gt;

&lt;p&gt;Change Stream 只推送已经在大多数节点上提交的变更操作。即“可重复读”的变更。 这个验证是通过&lt;code class=&quot;highlighter-rouge&quot;&gt; {readConcern: &quot;majority&quot;} &lt;/code&gt;实现的。因此:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;未开启majorityreadConcern的集群无法使用ChangeStream;&lt;/li&gt;
  &lt;li&gt;当集群无法满足&lt;code class=&quot;highlighter-rouge&quot;&gt;{w:&quot;majority&quot;}&lt;/code&gt;时，不会触发ChangeStream(例如PSA架构中的 S 因故障宕机)。&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;change-stream-变更过滤&quot;&gt;Change Stream 变更过滤&lt;/h3&gt;

&lt;p&gt;如果只对某些类型的变更事件感兴趣，可以使用使用聚合管道的过滤步骤过滤事件。
例如:&lt;/p&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;cs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;db&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;collection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;watch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([{&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;$match&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;na&quot;&gt;operationType&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;na&quot;&gt;$in&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'insert'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'delete'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}])&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;change-stream-示例&quot;&gt;Change Stream 示例&lt;/h3&gt;

&lt;p&gt;开启2个窗口:&lt;/p&gt;

&lt;p&gt;在窗口1执行监听：&lt;/p&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nx&quot;&gt;rs0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;PRIMARY&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;db&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;watch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([],{&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;maxAwaitTimeMS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;30000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}).&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;pretty&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;_id&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;s2&quot;&gt;&quot;_data&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;825EA7A400000000012B022C0100296E5A1004124DEBF980784545948639CB6F3A779146645F696400645EA7A400604B3753349DDA300004&quot;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;operationType&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;insert&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;clusterTime&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Timestamp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1588044800&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;fullDocument&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;s2&quot;&gt;&quot;_id&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;ObjectId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5ea7a400604b3753349dda30&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
                &lt;span class=&quot;s2&quot;&gt;&quot;x&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;ns&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;s2&quot;&gt;&quot;db&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;test&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;s2&quot;&gt;&quot;coll&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;test&quot;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;documentKey&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;s2&quot;&gt;&quot;_id&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;ObjectId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5ea7a400604b3753349dda30&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;窗口2 执行插入：&lt;/p&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nx&quot;&gt;rs0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;PRIMARY&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;db&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;insert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;WriteResult&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;nInserted&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;此刻窗口1会同步如下：&lt;/p&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;_id&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;s2&quot;&gt;&quot;_data&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;825EA7A400000000012B022C0100296E5A1004124DEBF980784545948639CB6F3A779146645F696400645EA7A400604B3753349DDA300004&quot;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;operationType&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;insert&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;clusterTime&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Timestamp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1588044800&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;fullDocument&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;s2&quot;&gt;&quot;_id&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;ObjectId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5ea7a400604b3753349dda30&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
                &lt;span class=&quot;s2&quot;&gt;&quot;x&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;ns&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;s2&quot;&gt;&quot;db&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;test&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;s2&quot;&gt;&quot;coll&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;test&quot;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;documentKey&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;s2&quot;&gt;&quot;_id&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;ObjectId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5ea7a400604b3753349dda30&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;这个功能跟gh-ost是不是有点神似？^_^&lt;/p&gt;

&lt;h3 id=&quot;change-stream-故障恢复&quot;&gt;Change Stream 故障恢复&lt;/h3&gt;

&lt;p&gt;想要从上次中断的地方继续获取变更流，只需要保留上次变更通知中的 &lt;em&gt;id 即可。&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;例如:
&lt;code class=&quot;highlighter-rouge&quot;&gt;var cs = db.collection.watch([], {resumeAfter: &amp;lt;_id&amp;gt;}) &lt;/code&gt;即可从上一条通知中断处继续获取后续的变更通知。&lt;/p&gt;

&lt;h3 id=&quot;change-stream-使用场景&quot;&gt;Change Stream 使用场景&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;跨集群的变更复制:&lt;/strong&gt;在源集群中订阅ChangeStream，一旦得到任何变更立即写入目标集群。&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;微服务联动:&lt;/strong&gt;当一个微服务变更数据库时，其他微服务得到通知并做出相应的变 更。&lt;/li&gt;
  &lt;li&gt;其他任何需要系统联动的场景。&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;注意事项&quot;&gt;注意事项&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;ChangeStream依赖于oplog，因此中断时间不可超过oplog回收的最大时间窗;&lt;/li&gt;
  &lt;li&gt;在执行update操作时，如果只更新了部分数据，那么ChangeStream通知的也是增量部分；&lt;/li&gt;
  &lt;li&gt;删除数据时通知的仅是删除数据的_id。&lt;/li&gt;
&lt;/ul&gt;</content><author><name>Nick</name></author><category term="mongodb" /><summary type="html">什么是 Change Stream Change Stream 是 MongoDB 用于实现变更追踪的解决方案，类似于关系数据库的触发器，但原理不完全相同:   Change Stream 触发器 触发方式 异步 同步 触发位置 应用回调事件 数据库触发器 触发次数 每个订阅事件的客户端 1次 故障恢复 从上次断点重新触发 事务回滚 Change Stream 的实现原理 Change Stream 是基于 oplog 实现的。它在 oplog 上开启一个 tailable cursor 来追踪所有复制集上的变更操作，最终调用应用中定义的回调函数。 被追踪的变更事件主要包括: insert/update/delete:插入、更新、删除; drop:集合被删除; rename:集合被重命名; dropDatabase:数据库被删除; invalidate:drop/rename/dropDatabase将导致invalidate被触发， 并关闭 change stream; Change Stream 与可重复读 Change Stream 只推送已经在大多数节点上提交的变更操作。即“可重复读”的变更。 这个验证是通过 {readConcern: &quot;majority&quot;} 实现的。因此: 未开启majorityreadConcern的集群无法使用ChangeStream; 当集群无法满足{w:&quot;majority&quot;}时，不会触发ChangeStream(例如PSA架构中的 S 因故障宕机)。 Change Stream 变更过滤 如果只对某些类型的变更事件感兴趣，可以使用使用聚合管道的过滤步骤过滤事件。 例如: var cs = db.collection.watch([{ $match: { operationType: { $in: ['insert', 'delete'] } } }]) Change Stream 示例 开启2个窗口: 在窗口1执行监听： rs0:PRIMARY&amp;gt; db.test.watch([],{maxAwaitTimeMS: 30000}).pretty() { &quot;_id&quot; : { &quot;_data&quot; : &quot;825EA7A400000000012B022C0100296E5A1004124DEBF980784545948639CB6F3A779146645F696400645EA7A400604B3753349DDA300004&quot; }, &quot;operationType&quot; : &quot;insert&quot;, &quot;clusterTime&quot; : Timestamp(1588044800, 1), &quot;fullDocument&quot; : { &quot;_id&quot; : ObjectId(&quot;5ea7a400604b3753349dda30&quot;), &quot;x&quot; : 1 }, &quot;ns&quot; : { &quot;db&quot; : &quot;test&quot;, &quot;coll&quot; : &quot;test&quot; }, &quot;documentKey&quot; : { &quot;_id&quot; : ObjectId(&quot;5ea7a400604b3753349dda30&quot;) } } 窗口2 执行插入： rs0:PRIMARY&amp;gt; db.test.insert({x:1}) WriteResult({ &quot;nInserted&quot; : 1 }) 此刻窗口1会同步如下： { &quot;_id&quot; : { &quot;_data&quot; : &quot;825EA7A400000000012B022C0100296E5A1004124DEBF980784545948639CB6F3A779146645F696400645EA7A400604B3753349DDA300004&quot; }, &quot;operationType&quot; : &quot;insert&quot;, &quot;clusterTime&quot; : Timestamp(1588044800, 1), &quot;fullDocument&quot; : { &quot;_id&quot; : ObjectId(&quot;5ea7a400604b3753349dda30&quot;), &quot;x&quot; : 1 }, &quot;ns&quot; : { &quot;db&quot; : &quot;test&quot;, &quot;coll&quot; : &quot;test&quot; }, &quot;documentKey&quot; : { &quot;_id&quot; : ObjectId(&quot;5ea7a400604b3753349dda30&quot;) } } 这个功能跟gh-ost是不是有点神似？^_^ Change Stream 故障恢复 想要从上次中断的地方继续获取变更流，只需要保留上次变更通知中的 id 即可。 例如: var cs = db.collection.watch([], {resumeAfter: &amp;lt;_id&amp;gt;}) 即可从上一条通知中断处继续获取后续的变更通知。 Change Stream 使用场景 跨集群的变更复制:在源集群中订阅ChangeStream，一旦得到任何变更立即写入目标集群。 微服务联动:当一个微服务变更数据库时，其他微服务得到通知并做出相应的变 更。 其他任何需要系统联动的场景。 注意事项 ChangeStream依赖于oplog，因此中断时间不可超过oplog回收的最大时间窗; 在执行update操作时，如果只更新了部分数据，那么ChangeStream通知的也是增量部分； 删除数据时通知的仅是删除数据的_id。</summary></entry><entry><title type="html">mongodb writeConcern初探</title><link href="http://localhost:4000/mongodb/2018/04/20/mongodb-writeConcern/" rel="alternate" type="text/html" title="mongodb writeConcern初探" /><published>2018-04-20T00:00:00+08:00</published><updated>2018-04-20T00:00:00+08:00</updated><id>http://localhost:4000/mongodb/2018/04/20/mongodb-writeConcern</id><content type="html" xml:base="http://localhost:4000/mongodb/2018/04/20/mongodb-writeConcern/">&lt;h3 id=&quot;什么是writeconcern&quot;&gt;什么是writeConcern&lt;/h3&gt;

&lt;p&gt;writeConcern 决定一个写操作落到多少个节点上才算成功。取值包括：&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;0 ：发起写操作，不关心是否成功。&lt;/li&gt;
  &lt;li&gt;1~集群最大节点数 ：写操作需要复制到指定节点数才算成功&lt;/li&gt;
  &lt;li&gt;majority：写操作需要复制到多数节点才算成功&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;发起写操作的程序将阻塞直到满足上诉条件。&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;writeConcern类似MySQL的半同步复制&lt;code class=&quot;highlighter-rouge&quot;&gt;--rpl-semi-sync-master-wait-for-slave-count&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;这里还要提到另一个概念：Journal 日志，跟MySQL的redo log类似，也是为了做crash safe。为了保证每次写数据都落盘，可以指定&lt;code class=&quot;highlighter-rouge&quot;&gt;j: true&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;注：3.2之前只要primary节点落盘就确认ok，3.2之后需要w:N都确认才ok&lt;/p&gt;
&lt;h3 id=&quot;writeconcern功能验证&quot;&gt;writeConcern功能验证&lt;/h3&gt;

&lt;h4 id=&quot;w-majority&quot;&gt;w: “majority”&lt;/h4&gt;

&lt;div class=&quot;language-json highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;rs&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;PRIMARY&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;db.test.insert(&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;writeConcern&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;majority&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}}&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;WriteResult(&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;nInserted&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;这是推荐的写法，mongodb会自己判断只要写入多数节点即返回成功&lt;/p&gt;

&lt;h4 id=&quot;w-节点数&quot;&gt;w: 节点数&lt;/h4&gt;

&lt;div class=&quot;language-json highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;rs&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;PRIMARY&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;db.test.insert(&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;writeConcern&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}}&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;WriteResult(&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;nInserted&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;可以看到正常情况下（secondary节点没延迟）也很快返回成功了。&lt;/p&gt;

&lt;h4 id=&quot;w节点数&quot;&gt;w＞节点数&lt;/h4&gt;

&lt;div class=&quot;language-json highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;rs&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;PRIMARY&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;db.test.insert(&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;writeConcern&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}}&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;WriteResult(&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;nInserted&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;writeConcernError&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
                &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;code&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
                &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;codeName&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;UnsatisfiableWriteConcern&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
                &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;errmsg&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Not enough data-bearing nodes&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;这里虽然报错了，但实际还是写入成功了。&lt;/p&gt;

&lt;h4 id=&quot;secondary节点有延迟的情况下观察现象&quot;&gt;secondary节点有延迟的情况下，观察现象&lt;/h4&gt;

&lt;p&gt;首先我们模拟延迟场景，在primary节点执行，模拟secondary 2节点延迟10秒&lt;/p&gt;

&lt;div class=&quot;language-json highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;conf=rs.conf()&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; 
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;conf.members&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;.slaveDelay&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;conf.members&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;.priority&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; 
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;rs.reconfig(conf)&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;观察复制延迟下的写入，以及timeout参数&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;db.test.insert( {count: 1}, {writeConcern: {w: 3}})&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-json highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;rs&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;PRIMARY&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;db.test.find()&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;_id&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ObjectId(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5e9d7bf6d4eb493af10599c9&quot;&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;count&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;_id&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ObjectId(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5e9d7cf4d4eb493af10599ca&quot;&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;count&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;_id&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ObjectId(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5e9d7e2ad4eb493af10599cb&quot;&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;count&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;rs&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;PRIMARY&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;db.test.insert(&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;writeConcern&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}}&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;这里会等待&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;WriteResult(&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;nInserted&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;rs&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;PRIMARY&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;db.test.find()&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;_id&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ObjectId(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5e9d7bf6d4eb493af10599c9&quot;&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;count&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;_id&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ObjectId(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5e9d7cf4d4eb493af10599ca&quot;&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;count&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;_id&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ObjectId(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5e9d7e2ad4eb493af10599cb&quot;&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;count&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;_id&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ObjectId(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5e9d7f9ad4eb493af10599cc&quot;&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;count&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;db.test.insert( {count: 1}, {writeConcern: {w: 3, wtimeout:3000 }})&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-json highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;rs&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;PRIMARY&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;db.test.find()&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;_id&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ObjectId(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5e9d7bf6d4eb493af10599c9&quot;&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;count&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;_id&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ObjectId(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5e9d7cf4d4eb493af10599ca&quot;&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;count&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;_id&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ObjectId(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5e9d7e2ad4eb493af10599cb&quot;&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;count&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;_id&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ObjectId(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5e9d7f9ad4eb493af10599cc&quot;&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;count&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;rs&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;PRIMARY&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;db.test.insert(&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;writeConcern&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;wtimeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3000&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}}&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;这里等&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;s后报错，实际命令敲下的一瞬间已写入到primary和没延迟的secondary，延迟节点需要等&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;s后落盘。&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;WriteResult(&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;nInserted&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;writeConcernError&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
                &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;code&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
                &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;codeName&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;WriteConcernFailed&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
                &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;errmsg&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;waiting for replication timed out&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
                &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;errInfo&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
                        &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;wtimeout&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
                &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;rs&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;PRIMARY&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;db.test.find()&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;_id&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ObjectId(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5e9d7bf6d4eb493af10599c9&quot;&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;count&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;_id&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ObjectId(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5e9d7cf4d4eb493af10599ca&quot;&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;count&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;_id&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ObjectId(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5e9d7e2ad4eb493af10599cb&quot;&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;count&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;_id&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ObjectId(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5e9d7f9ad4eb493af10599cc&quot;&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;count&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;_id&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ObjectId(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5e9d800ed4eb493af10599cd&quot;&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;count&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;总结&quot;&gt;总结&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;虽然多于半数的writeConcern都是安全的，但通常只会设置majority，因为这是等待写入延迟时间最短的选择;&lt;/li&gt;
  &lt;li&gt;不要设置writeConcern等于总节点数，因为一旦有一个节点故障，所有写操作都将失败;&lt;/li&gt;
  &lt;li&gt;writeConcern虽然会增加写操作延迟时间，但并不会显著增加集群压力，因此无论是否等待，写操作最终都会复制到所有节点上。设置 writeConcern 只是让写操作等待复制后再返回而已;&lt;/li&gt;
  &lt;li&gt;应对重要数据应用{w:“majority”}，普通数据可以应用{w:1}以确保最佳性能。&lt;/li&gt;
&lt;/ul&gt;</content><author><name>Nick</name></author><category term="mongodb" /><summary type="html">什么是writeConcern writeConcern 决定一个写操作落到多少个节点上才算成功。取值包括： 0 ：发起写操作，不关心是否成功。 1~集群最大节点数 ：写操作需要复制到指定节点数才算成功 majority：写操作需要复制到多数节点才算成功 发起写操作的程序将阻塞直到满足上诉条件。 writeConcern类似MySQL的半同步复制--rpl-semi-sync-master-wait-for-slave-count 这里还要提到另一个概念：Journal 日志，跟MySQL的redo log类似，也是为了做crash safe。为了保证每次写数据都落盘，可以指定j: true 注：3.2之前只要primary节点落盘就确认ok，3.2之后需要w:N都确认才ok writeConcern功能验证 w: “majority” rs0:PRIMARY&amp;gt; db.test.insert( {count: 1}, {writeConcern: {w: &quot;majority&quot;}}) WriteResult({ &quot;nInserted&quot; : 1 }) 这是推荐的写法，mongodb会自己判断只要写入多数节点即返回成功 w: 节点数 rs0:PRIMARY&amp;gt; db.test.insert( {count: 1}, {writeConcern: {w: 3 }}) WriteResult({ &quot;nInserted&quot; : 1 }) 可以看到正常情况下（secondary节点没延迟）也很快返回成功了。 w＞节点数 rs0:PRIMARY&amp;gt; db.test.insert( {count: 1}, {writeConcern: {w: 4}}) WriteResult({ &quot;nInserted&quot; : 1, &quot;writeConcernError&quot; : { &quot;code&quot; : 100, &quot;codeName&quot; : &quot;UnsatisfiableWriteConcern&quot;, &quot;errmsg&quot; : &quot;Not enough data-bearing nodes&quot; } }) 这里虽然报错了，但实际还是写入成功了。 secondary节点有延迟的情况下，观察现象 首先我们模拟延迟场景，在primary节点执行，模拟secondary 2节点延迟10秒 conf=rs.conf() conf.members[2].slaveDelay = 10 conf.members[2].priority = 0 rs.reconfig(conf) 观察复制延迟下的写入，以及timeout参数 db.test.insert( {count: 1}, {writeConcern: {w: 3}}) rs0:PRIMARY&amp;gt; db.test.find() { &quot;_id&quot; : ObjectId(&quot;5e9d7bf6d4eb493af10599c9&quot;), &quot;count&quot; : 1 } { &quot;_id&quot; : ObjectId(&quot;5e9d7cf4d4eb493af10599ca&quot;), &quot;count&quot; : 1 } { &quot;_id&quot; : ObjectId(&quot;5e9d7e2ad4eb493af10599cb&quot;), &quot;count&quot; : 1 } rs0:PRIMARY&amp;gt; db.test.insert( {count: 1}, {writeConcern: {w: 3}}) # 这里会等待10s WriteResult({ &quot;nInserted&quot; : 1 }) rs0:PRIMARY&amp;gt; db.test.find() { &quot;_id&quot; : ObjectId(&quot;5e9d7bf6d4eb493af10599c9&quot;), &quot;count&quot; : 1 } { &quot;_id&quot; : ObjectId(&quot;5e9d7cf4d4eb493af10599ca&quot;), &quot;count&quot; : 1 } { &quot;_id&quot; : ObjectId(&quot;5e9d7e2ad4eb493af10599cb&quot;), &quot;count&quot; : 1 } { &quot;_id&quot; : ObjectId(&quot;5e9d7f9ad4eb493af10599cc&quot;), &quot;count&quot; : 1 } db.test.insert( {count: 1}, {writeConcern: {w: 3, wtimeout:3000 }}) rs0:PRIMARY&amp;gt; db.test.find() { &quot;_id&quot; : ObjectId(&quot;5e9d7bf6d4eb493af10599c9&quot;), &quot;count&quot; : 1 } { &quot;_id&quot; : ObjectId(&quot;5e9d7cf4d4eb493af10599ca&quot;), &quot;count&quot; : 1 } { &quot;_id&quot; : ObjectId(&quot;5e9d7e2ad4eb493af10599cb&quot;), &quot;count&quot; : 1 } { &quot;_id&quot; : ObjectId(&quot;5e9d7f9ad4eb493af10599cc&quot;), &quot;count&quot; : 1 } rs0:PRIMARY&amp;gt; db.test.insert( {count: 1}, {writeConcern: {w: 3, wtimeout:3000 }}) # 这里等3s后报错，实际命令敲下的一瞬间已写入到primary和没延迟的secondary，延迟节点需要等10s后落盘。 WriteResult({ &quot;nInserted&quot; : 1, &quot;writeConcernError&quot; : { &quot;code&quot; : 64, &quot;codeName&quot; : &quot;WriteConcernFailed&quot;, &quot;errmsg&quot; : &quot;waiting for replication timed out&quot;, &quot;errInfo&quot; : { &quot;wtimeout&quot; : true } } }) rs0:PRIMARY&amp;gt; db.test.find() { &quot;_id&quot; : ObjectId(&quot;5e9d7bf6d4eb493af10599c9&quot;), &quot;count&quot; : 1 } { &quot;_id&quot; : ObjectId(&quot;5e9d7cf4d4eb493af10599ca&quot;), &quot;count&quot; : 1 } { &quot;_id&quot; : ObjectId(&quot;5e9d7e2ad4eb493af10599cb&quot;), &quot;count&quot; : 1 } { &quot;_id&quot; : ObjectId(&quot;5e9d7f9ad4eb493af10599cc&quot;), &quot;count&quot; : 1 } { &quot;_id&quot; : ObjectId(&quot;5e9d800ed4eb493af10599cd&quot;), &quot;count&quot; : 1 } 总结 虽然多于半数的writeConcern都是安全的，但通常只会设置majority，因为这是等待写入延迟时间最短的选择; 不要设置writeConcern等于总节点数，因为一旦有一个节点故障，所有写操作都将失败; writeConcern虽然会增加写操作延迟时间，但并不会显著增加集群压力，因此无论是否等待，写操作最终都会复制到所有节点上。设置 writeConcern 只是让写操作等待复制后再返回而已; 应对重要数据应用{w:“majority”}，普通数据可以应用{w:1}以确保最佳性能。</summary></entry><entry><title type="html">mongodb readPreference 和 readConcern初探</title><link href="http://localhost:4000/mongodb/2018/04/20/mongodb-readPreference&readConcern/" rel="alternate" type="text/html" title="mongodb readPreference 和 readConcern初探" /><published>2018-04-20T00:00:00+08:00</published><updated>2018-04-20T00:00:00+08:00</updated><id>http://localhost:4000/mongodb/2018/04/20/mongodb-readPreference&amp;readConcern</id><content type="html" xml:base="http://localhost:4000/mongodb/2018/04/20/mongodb-readPreference&amp;readConcern/">&lt;h3 id=&quot;综述&quot;&gt;综述&lt;/h3&gt;

&lt;p&gt;在读取数据的过程中我们需要关注以下两个问题:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;从哪里读?&lt;/li&gt;
  &lt;li&gt;什么样的数据可以读?&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;第一个问题是是由 readPreference 来解决 第二个问题则是由 readConcern 来解决&lt;/p&gt;

&lt;h3 id=&quot;什么是-readpreference&quot;&gt;什么是 readPreference&lt;/h3&gt;

&lt;p&gt;readPreference 决定使用哪一个节点来满足 正在发起的读请求。可选值包括:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;primary:只选择主节点;&lt;/li&gt;
  &lt;li&gt;primaryPreferred:优先选择主节点，如果不可用则选择从节点;&lt;/li&gt;
  &lt;li&gt;secondary:只选择从节点;&lt;/li&gt;
  &lt;li&gt;secondaryPreferred:优先选择从节点， 如果从节点不可用则选择主节点;&lt;/li&gt;
  &lt;li&gt;nearest:选择最近的节点;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;readpreference-场景举例&quot;&gt;readPreference 场景举例&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;primary/primaryPreferred&lt;/strong&gt; 用户下订单后马上将用户转到订单详情页,因为此时从节点可能还没复制到新订单;&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;secondary/secondaryPreferred&lt;/strong&gt; 用户查询自己下过的订单。查询历史订单对 时效性通常没有太高要求;&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;secondary&lt;/strong&gt; 生成报表。报表对时效性要求不高，但资源需求大，可以在从节点 单独处理，避免对线上用户造成影响;&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;nearest&lt;/strong&gt;将用户上传的图片分发到全世界，让各地用户能够就近读取。每个地区 的应用选择最近的节点读取数据。&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;readpreference-与-tag&quot;&gt;readPreference 与 Tag&lt;/h3&gt;

&lt;p&gt;readPreference 只能控制使用一类节点。Tag 则可以将节点选择控制 到一个或几个节点。考虑以下场景:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;一个5个节点的复制集;&lt;/li&gt;
  &lt;li&gt;3个节点硬件较好，专用于服务线上客户;&lt;/li&gt;
  &lt;li&gt;2个节点硬件较差，专用于生成报表&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;可以使用 Tag 来达到这样的控制目的:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;为3个较好的节点打上{purpose:”online”};&lt;/li&gt;
  &lt;li&gt;为2个较差的节点打上{purpose:”analyse”};&lt;/li&gt;
  &lt;li&gt;在线应用读取时指定online，报表读取时指定analyse。&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;readpreference-配置&quot;&gt;readPreference 配置&lt;/h3&gt;

&lt;p&gt;&lt;strong&gt;通过 MongoDB 的连接串参数:&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;mongodb://host1:27107,host2:27107,host3:27017/?replicaSet=rs&amp;amp;readPre ference=secondary&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;通过 MongoDB 驱动程序 API:&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;MongoCollection.withReadPreference(ReadPreferencereadPref)&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;Mongo Shell:&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;db.collection.find({}).readPref(“secondary”)&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;readpreference注意事项&quot;&gt;readPreference注意事项&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;指定readPreference时也应注意高可用问题。例如将readPreference指定primary，则发生故障转移不存在 primary 期间将没有节点可读。如果业务允许，则应选择 primaryPreferred;&lt;/li&gt;
  &lt;li&gt;使用Tag时也会遇到同样的问题，如果只有一个节点拥有一个特定Tag，则在这个节点失效时将无节点可读。这在有时候是期望的结果，有时候不是。例如:
    &lt;ul&gt;
      &lt;li&gt;如果报表使用的节点失效，即使不生成报表，通常也不希望将报表负载转移到其他节点上，此时只有一个节点有报表 Tag 是合理的选择;&lt;/li&gt;
      &lt;li&gt;如果线上节点失效，通常希望有替代节点，所以应该保持多个节点有同样的Tag;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Tag有时需要与优先级、选举权综合考虑。例如做报表的节点通常不会希望它成为主节点，则优先级应为 0。&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;h3 id=&quot;什么是-readconcern&quot;&gt;什么是 readConcern&lt;/h3&gt;

&lt;p&gt;在 readPreference 选择了指定的节点后，readConcern 决定这个节点上的数据哪些 是可读的，类似于关系数据库的隔离级别。可选值包括:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;available:读取所有可用的数据;&lt;/li&gt;
  &lt;li&gt;local:读取所有可用且属于当前分片的数据;&lt;/li&gt;
  &lt;li&gt;majority:读取在大多数节点上提交完成的数据;&lt;/li&gt;
  &lt;li&gt;linearizable:可线性化读取文档;&lt;/li&gt;
  &lt;li&gt;snapshot:读取最近快照中的数据;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;readconcern-local-和-available&quot;&gt;readConcern: local 和 available&lt;/h3&gt;

&lt;p&gt;在复制集中 local 和 available 是没有区别的。两者的区别主要体现在分片集上。考虑以下场景:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;一个chunkx正在从shard1向shard2迁移;&lt;/li&gt;
  &lt;li&gt;整个迁移过程中chunkx中的部分数据会在shard1和shard2中同时存在，但源分片shard1仍然是 chunk x 的负责方:
    &lt;ul&gt;
      &lt;li&gt;所有对chunkx的读写操作仍然进入shard1;&lt;/li&gt;
      &lt;li&gt;config中记录的信息chunkx仍然属于shard1;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;此时如果读shard2，则会体现出local和available的区别:
    &lt;ul&gt;
      &lt;li&gt;local:只取应该由shard2负责的数据(不包括x);&lt;/li&gt;
      &lt;li&gt;available:shard2上有什么就读什么(包括x);&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;注意事项:&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;虽然看上去总是应该选择local，但毕竟对结果集进行过滤会造成额外消耗。在一些无关紧要的场景(例如统计)下，也可以考虑 available;&lt;/li&gt;
  &lt;li&gt;MongoDB&amp;lt;=3.6不支持对从节点使用{readConcern:”local”};&lt;/li&gt;
  &lt;li&gt;从主节点读取数据时默认readConcern是local，从从节点读取数据时默认 readConcern 是 available(向前兼容原因)。&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;readconcern-majority-与脏读&quot;&gt;readConcern: majority 与脏读&lt;/h3&gt;

&lt;p&gt;如果在一次写操作到达大多数节点前读取了这个写操作，然后因为系统故障该操作回滚了，则发生了脏读问题;&lt;/p&gt;

&lt;p&gt;使用 {readConcern: “majority”} 可以有效避免脏读&lt;/p&gt;

&lt;h3 id=&quot;readconcern-如何实现安全的读写分离&quot;&gt;readConcern: 如何实现安全的读写分离&lt;/h3&gt;

&lt;p&gt;考虑如下场景:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;向主节点写入一条数据;&lt;/li&gt;
  &lt;li&gt;立即从从节点读取这条数据。&lt;/li&gt;
  &lt;li&gt;如何保证自己能够读到刚刚写入的数据?&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;下述方式有可能读不到刚写入的订单&lt;/p&gt;

&lt;div class=&quot;language-json highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;db.orders.insert(&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;oid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;101&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;sku&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;”kite&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;, q: 1}) db.orders.find({oid:101}).readPref(&quot;&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;secondary&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;)
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;使用 writeConcern + readConcern majority 来解决&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-json highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;db.orders.insert(&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;oid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;101&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;sku&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;kiteboar&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;err&quot;&gt;q&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;writeConcern&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:{&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;majority”}}) db.orders.find({oid:101}).readPref(&quot;&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;secondary&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;).readConcern(&quot;&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;majority&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;)
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name>Nick</name></author><category term="mongodb" /><summary type="html">综述 在读取数据的过程中我们需要关注以下两个问题: 从哪里读? 什么样的数据可以读? 第一个问题是是由 readPreference 来解决 第二个问题则是由 readConcern 来解决 什么是 readPreference readPreference 决定使用哪一个节点来满足 正在发起的读请求。可选值包括: primary:只选择主节点; primaryPreferred:优先选择主节点，如果不可用则选择从节点; secondary:只选择从节点; secondaryPreferred:优先选择从节点， 如果从节点不可用则选择主节点; nearest:选择最近的节点; readPreference 场景举例 primary/primaryPreferred 用户下订单后马上将用户转到订单详情页,因为此时从节点可能还没复制到新订单; secondary/secondaryPreferred 用户查询自己下过的订单。查询历史订单对 时效性通常没有太高要求; secondary 生成报表。报表对时效性要求不高，但资源需求大，可以在从节点 单独处理，避免对线上用户造成影响; nearest将用户上传的图片分发到全世界，让各地用户能够就近读取。每个地区 的应用选择最近的节点读取数据。 readPreference 与 Tag readPreference 只能控制使用一类节点。Tag 则可以将节点选择控制 到一个或几个节点。考虑以下场景: 一个5个节点的复制集; 3个节点硬件较好，专用于服务线上客户; 2个节点硬件较差，专用于生成报表 可以使用 Tag 来达到这样的控制目的: 为3个较好的节点打上{purpose:”online”}; 为2个较差的节点打上{purpose:”analyse”}; 在线应用读取时指定online，报表读取时指定analyse。 readPreference 配置 通过 MongoDB 的连接串参数: mongodb://host1:27107,host2:27107,host3:27017/?replicaSet=rs&amp;amp;readPre ference=secondary 通过 MongoDB 驱动程序 API: MongoCollection.withReadPreference(ReadPreferencereadPref) Mongo Shell: db.collection.find({}).readPref(“secondary”) readPreference注意事项 指定readPreference时也应注意高可用问题。例如将readPreference指定primary，则发生故障转移不存在 primary 期间将没有节点可读。如果业务允许，则应选择 primaryPreferred; 使用Tag时也会遇到同样的问题，如果只有一个节点拥有一个特定Tag，则在这个节点失效时将无节点可读。这在有时候是期望的结果，有时候不是。例如: 如果报表使用的节点失效，即使不生成报表，通常也不希望将报表负载转移到其他节点上，此时只有一个节点有报表 Tag 是合理的选择; 如果线上节点失效，通常希望有替代节点，所以应该保持多个节点有同样的Tag; Tag有时需要与优先级、选举权综合考虑。例如做报表的节点通常不会希望它成为主节点，则优先级应为 0。 什么是 readConcern 在 readPreference 选择了指定的节点后，readConcern 决定这个节点上的数据哪些 是可读的，类似于关系数据库的隔离级别。可选值包括: available:读取所有可用的数据; local:读取所有可用且属于当前分片的数据; majority:读取在大多数节点上提交完成的数据; linearizable:可线性化读取文档; snapshot:读取最近快照中的数据; readConcern: local 和 available 在复制集中 local 和 available 是没有区别的。两者的区别主要体现在分片集上。考虑以下场景: 一个chunkx正在从shard1向shard2迁移; 整个迁移过程中chunkx中的部分数据会在shard1和shard2中同时存在，但源分片shard1仍然是 chunk x 的负责方: 所有对chunkx的读写操作仍然进入shard1; config中记录的信息chunkx仍然属于shard1; 此时如果读shard2，则会体现出local和available的区别: local:只取应该由shard2负责的数据(不包括x); available:shard2上有什么就读什么(包括x); 注意事项: 虽然看上去总是应该选择local，但毕竟对结果集进行过滤会造成额外消耗。在一些无关紧要的场景(例如统计)下，也可以考虑 available; MongoDB&amp;lt;=3.6不支持对从节点使用{readConcern:”local”}; 从主节点读取数据时默认readConcern是local，从从节点读取数据时默认 readConcern 是 available(向前兼容原因)。 readConcern: majority 与脏读 如果在一次写操作到达大多数节点前读取了这个写操作，然后因为系统故障该操作回滚了，则发生了脏读问题; 使用 {readConcern: “majority”} 可以有效避免脏读 readConcern: 如何实现安全的读写分离 考虑如下场景: 向主节点写入一条数据; 立即从从节点读取这条数据。 如何保证自己能够读到刚刚写入的数据? 下述方式有可能读不到刚写入的订单 db.orders.insert({ oid: 101, sku: ”kite&quot;, q: 1}) db.orders.find({oid:101}).readPref(&quot;secondary&quot;) 使用 writeConcern + readConcern majority 来解决 db.orders.insert({ oid: 101, sku: &quot;kiteboar&quot;, q: 1}, {writeConcern:{w: &quot;majority”}}) db.orders.find({oid:101}).readPref(&quot;secondary&quot;).readConcern(&quot;majority&quot;)</summary></entry><entry><title type="html">mongodb复制集环境搭建</title><link href="http://localhost:4000/mongodb/2018/04/20/mongo_replset_building/" rel="alternate" type="text/html" title="mongodb复制集环境搭建" /><published>2018-04-20T00:00:00+08:00</published><updated>2018-04-20T00:00:00+08:00</updated><id>http://localhost:4000/mongodb/2018/04/20/mongo_replset_building</id><content type="html" xml:base="http://localhost:4000/mongodb/2018/04/20/mongo_replset_building/">&lt;blockquote&gt;
  &lt;p&gt;目标：在mac上部署3个节点的复制集，为后续测试准备环境&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;创建目录&quot;&gt;创建目录：&lt;/h3&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;mkdir -p /data/mongodb/db{1,2,3}&lt;/code&gt;&lt;/p&gt;

&lt;h3 id=&quot;编辑配置文件&quot;&gt;编辑配置文件：&lt;/h3&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;cat /data/mongodb/db1/mongod.conf &lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;systemLog:
    destination: file
    path: /data/mongodb/db1/mongod.log
    logAppend: true
storage:
    dbPath: /data/mongodb/db1
net:
    bindIp: 0.0.0.0
    port: 28017
replication:
    replSetName: rs0
processManagement:
    fork: true
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;其他节点只需修改path和port即可&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;启动mongod&quot;&gt;启动mongod：&lt;/h3&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;mongod -f /data/db1/mongod.conf&lt;/code&gt;&lt;/p&gt;

&lt;h3 id=&quot;配置复制集&quot;&gt;配置复制集：&lt;/h3&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;mongo --port 28017&lt;/code&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;方法一&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;gt; rs.initiate()
&amp;gt; rs.add(&quot;HOSTNAME:28018&quot;) 
&amp;gt; rs.add(&quot;HOSTNAME:28019&quot;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;方法二&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;mongo --port 28017&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;gt; rs.initiate({
    _id: &quot;rs0&quot;,
    members: [
    {_id: 0,host: &quot;localhost:28017&quot; },
    {_id: 1,host: &quot;localhost:28018&quot; },
    {_id: 2,host: &quot;localhost:28019&quot; }
    ]
})
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;验证&quot;&gt;验证&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;MongoDB 主节点进行写入&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;mongo localhost:28017&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;&amp;gt; db.test.insert({ a:1 })&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;&amp;gt; db.test.insert({ a:2 });&lt;/code&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;MongoDB 从节点进行读&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;mongo localhost:28018&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;gt; rs.slaveOk()
&amp;gt; db.test.find()
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/downloads/image-20200420160908919.png&quot; alt=&quot;image-20200420160908919&quot; /&gt;&lt;/p&gt;</content><author><name>Nick</name></author><category term="mongodb" /><summary type="html">目标：在mac上部署3个节点的复制集，为后续测试准备环境 创建目录： mkdir -p /data/mongodb/db{1,2,3} 编辑配置文件： cat /data/mongodb/db1/mongod.conf systemLog: destination: file path: /data/mongodb/db1/mongod.log logAppend: true storage: dbPath: /data/mongodb/db1 net: bindIp: 0.0.0.0 port: 28017 replication: replSetName: rs0 processManagement: fork: true 其他节点只需修改path和port即可 启动mongod： mongod -f /data/db1/mongod.conf 配置复制集： mongo --port 28017 方法一 &amp;gt; rs.initiate() &amp;gt; rs.add(&quot;HOSTNAME:28018&quot;) &amp;gt; rs.add(&quot;HOSTNAME:28019&quot;) 方法二 mongo --port 28017 &amp;gt; rs.initiate({ _id: &quot;rs0&quot;, members: [ {_id: 0,host: &quot;localhost:28017&quot; }, {_id: 1,host: &quot;localhost:28018&quot; }, {_id: 2,host: &quot;localhost:28019&quot; } ] }) 验证 MongoDB 主节点进行写入 mongo localhost:28017 &amp;gt; db.test.insert({ a:1 }) &amp;gt; db.test.insert({ a:2 }); MongoDB 从节点进行读 mongo localhost:28018 &amp;gt; rs.slaveOk() &amp;gt; db.test.find()</summary></entry></feed>